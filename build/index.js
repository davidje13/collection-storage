!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("collection-storage",[],t):"object"==typeof exports?exports["collection-storage"]=t():e["collection-storage"]=t()}(global,(function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=9)}([function(e,t,n){"use strict";function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,"a",(function(){return s}));class s{constructor(e){this.keys=e,i(this,"internalReady",void 0),i(this,"innerPreAct",void 0),this.innerPreAct=this.preAct.bind(this)}async add(e){return await this.innerPreAct(),this.internalAdd(e)}async get(e,t,n){if(!this.isIndexed(e))throw new Error("No index for "+e);return await this.innerPreAct(),this.internalGet(e,t,n)}async getAll(e,t,n){if(e&&!this.isIndexed(e))throw new Error("No index for "+e);return await this.innerPreAct(),this.internalGetAll(e,t,n)}async update(e,t,n,s={}){if("id"===e&&void 0!==n.id&&n.id!==t)throw new Error("Cannot update ID");if(s.upsert){if("id"!==e)throw new Error("Can only upsert by ID, not "+e);let a=n;return Object.prototype.hasOwnProperty.call(n,"id")&&(a=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},n),delete a.id),await this.innerPreAct(),this.internalUpsert(t,a,s)}if(!this.isIndexed(e))throw new Error("No index for "+e);if(!this.isIndexUnique(e)&&Object.keys(n).some(e=>this.isIndexUnique(e)))throw new Error("duplicate");return await this.innerPreAct(),this.internalUpdate(e,t,n,s)}async remove(e,t){if(!this.isIndexed(e))throw new Error("No index for "+e);return await this.innerPreAct(),this.internalRemove(e,t)}async initAsync(e){const t=[],n=()=>new Promise((e,n)=>{t.push([e,n])});this.internalReady=n,this.innerPreAct=async()=>(await n(),this.preAct());try{await e}catch(e){return this.internalReady=()=>Promise.reject(e),this.innerPreAct=()=>{throw e},void t.forEach(t=>t[1](e))}this.internalReady=void 0,this.innerPreAct=this.preAct.bind(this),t.forEach(e=>e[0]())}isIndexed(e){return"id"===e||void 0!==this.keys[e]}isIndexUnique(e){const t=this.keys[e];return"id"===e||Boolean(t&&t.unique)}preAct(){}async internalGet(e,t,n){var r;return null!==(r=(await this.internalGetAll(e,t,n))[0])&&void 0!==r?r:null}internalUpsert(e,t,n){return this.internalUpdate("id",e,t,n)}}},function(e,t){e.exports=require("crypto")},function(e,t,n){"use strict";function r(e){return new Promise(t=>setTimeout(t,e))}t.a=(e,{timeoutMillis:t=6e4,initialDelayMillis:n=20,maxDelayMillis:i=5e3,delayGrowth:s=2,jitter:a=!0}={})=>async o=>{const c=Date.now()+t;let l=n;for(let t=1;;t+=1)try{return await o()}catch(n){if(!e(n))throw n;const o=Math.min(l,i)*(a?Math.random():1);if(l*=s,Date.now()+o>c)throw n.message+=` (timeout after ${t} attempts)`,n;await r(o)}}},function(e,t){e.exports=require("mongodb")},function(e,t){e.exports=require("zlib")},function(e,t){e.exports=require("util")},function(e,t){e.exports=require("url")},function(e,t){e.exports=require("https")},function(e,t){e.exports=require("http")},function(e,t,n){e.exports=n(13)},function(e,t,n){"use strict";n.r(t),n.d(t,"default",(function(){return f}));var r=n(3),i=n(0),s=n(2);const a=/\./g;function o(e){return"id"===e?"_id":encodeURIComponent(e).replace(a,"%2E")}const c=/^.*? index: ([^ ]+) dup key:.*$/;const l=Object(s.a)(e=>e instanceof r.MongoError&&11e3===e.code&&"_id_"===function(e){var t;return(null===(t=c.exec(e.message))||void 0===t?void 0:t[1])||""}(e));function u(e){const t={};return Object.keys(e).forEach(n=>{let i=e[n];if(i instanceof Buffer)i=new r.Binary(i);else if("object"==typeof i&&i._bsontype)throw new Error("Must use Buffer to provide binary data");t[o(n)]=i}),t}function h(e){if(!e)return null;const t={};return Object.keys(e).forEach(n=>{let r=e[n];var i;"object"==typeof r&&"Binary"===r._bsontype&&(r=r.buffer),t[(i=n,"_id"===i?"id":decodeURIComponent(i))]=r}),t}function d(e){const t={};return e&&(t._id=!1,e.forEach(e=>{t[o(e)]=!0})),t}async function p(e,t={}){const n=await e.indexes().catch(()=>[]),r=[],i=new Set(n.map(e=>e.name));i.delete("_id_"),Object.keys(t).map(e=>function(e,t={}){const n=Boolean(t.unique);return{key:{[o(e)]:n?1:"hashed"},unique:n}}(e,t[e])).forEach(e=>{const t=n.find(t=>function(e,t){if(Boolean(e.unique)!==Boolean(t.unique))return!1;const n=e.key,r=t.key,i=Object.keys(n);return Object.keys(r).length===i.length&&i.every(e=>n[e]===r[e])}(t,e));t?i.delete(t.name):r.push(e)}),r.length&&await e.createIndexes(r),i.size&&await Promise.all([...i].map(t=>e.dropIndex(t)))}class f extends i.a{constructor(e,t={},n={closed:!1}){super(t),this.collection=e,this.stateRef=n,this.initAsync(p(e,t))}preAct(){if(this.stateRef.closed)throw new Error("Connection closed")}async internalAdd(e){await this.collection.insertOne(u(e))}async internalUpsert(e,t){await l(()=>this.collection.updateOne(u({id:e}),{$set:u(t)},{upsert:!0}))}async internalUpdate(e,t,n){const r=u({[e]:t}),i={$set:u(n)};this.isIndexUnique(e)?await this.collection.updateOne(r,i):await this.collection.updateMany(r,i)}async internalGet(e,t,n){return h(await this.collection.findOne(u({[e]:t}),{projection:d(n)}))}async internalGetAll(e,t,n){const r=this.collection.find(e?u({[e]:t}):{},{projection:d(n)}),i=[];return await r.forEach(e=>i.push(h(e))),i}async internalRemove(e,t){return(await this.collection.deleteMany(u({[e]:t}))).deletedCount||0}}},function(e,t){e.exports=require("ioredis")},function(e,t){e.exports=require("pg")},function(e,t,n){"use strict";n.r(t),n.d(t,"MemoryDb",(function(){return O})),n.d(t,"MongoDb",(function(){return C})),n.d(t,"RedisDb",(function(){return Ye})),n.d(t,"LruCache",(function(){return pe})),n.d(t,"WrappedCollection",(function(){return ut})),n.d(t,"encryptByKey",(function(){return yt})),n.d(t,"encryptByRecord",(function(){return wt})),n.d(t,"encryptByRecordWithMasterKey",(function(){return bt})),n.d(t,"compress",(function(){return Tt})),n.d(t,"migrate",(function(){return Pt})),n.d(t,"nodeEncryptionSync",(function(){return pt}));var r=n(6),i=n(0);const s="b".charCodeAt(0),a="s".charCodeAt(0),o=Uint8Array.of(s);function c(e){return e instanceof Buffer?"B"+e.toString("base64"):"string"==typeof e?"s"+e:"boolean"==typeof e?e?"t":"f":null===e?"n":"J"+JSON.stringify(e)}function l(e){const t=e[0],n=e.substr(1);switch(t){case"B":return Buffer.from(n,"base64");case"s":return n;case"t":return!0;case"f":return!1;case"n":return null;case"J":return JSON.parse(n);default:if('{["0123456789-'.includes(t))return JSON.parse(e);throw new Error("Unknown data type "+t)}}function u(e){return e instanceof Buffer?Buffer.concat([o,e]):Buffer.from(c(e),"utf8")}function h(e){if("string"==typeof e)return l(e);const t=e[0];return t===s?e.subarray(1):t===a?e.subarray(1).toString("utf8"):l(e.toString("utf8"))}function d(e){const t={};return Object.keys(e).forEach(n=>{t[n]=c(e[n])}),t}function p(e){const t={};return Object.keys(e).forEach(n=>{const r=e[n];r&&(t[n]=l(r))}),t}function f(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function y(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?f(Object(n),!0).forEach((function(t){w(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):f(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function w(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class b extends i.a{constructor(e={},t=0,n={closed:!1}){super(e),this.simulatedLatency=t,this.stateRef=n,w(this,"data",void 0),w(this,"indices",{}),this.data=new Map,Object.keys(e).forEach(e=>{this.indices[e]=new Map})}preAct(){if(this.stateRef.closed)throw new Error("Connection closed");return function(e){if(e)return new Promise(t=>setTimeout(t,e))}(this.simulatedLatency)}async internalAdd(e){const t=d(e);this.internalCheckDuplicates(t,!0),this.data.set(t.id,t),this.internalPopulateIndices(t)}async internalUpsert(e,t){this.data.has(c(e))?await this.internalUpdate("id",e,t):await this.internalAdd(y({id:e},t))}async internalUpdate(e,t,n){const r=this.internalGetSerialisedIds(e,t).map(e=>{const t=this.data.get(e),r=p(t),i=y(y({},r),n);if(i.id!==r.id)throw new Error("Cannot update ID");return{oldSerialised:t,newSerialised:d(i)}});r.forEach(({oldSerialised:e})=>this.internalRemoveIndices(e));try{r.forEach(({newSerialised:e})=>this.internalCheckDuplicates(e,!1))}catch(e){throw r.forEach(({oldSerialised:e})=>this.internalPopulateIndices(e)),e}r.forEach(({newSerialised:e})=>{this.data.set(e.id,e),this.internalPopulateIndices(e)})}async internalGetAll(e,t,n){let r;return r=e?this.internalGetSerialisedIds(e,t):[...this.data.keys()],r.map(e=>function(e,t){if(!t)return e;const n={};return t.forEach(t=>{n[t]=e[t]}),n}(p(this.data.get(e)),n))}async internalRemove(e,t){const n=this.internalGetSerialisedIds(e,t);return n.forEach(e=>{const t=this.data.get(e);this.internalRemoveIndices(t),this.data.delete(e)}),n.length}internalGetSerialisedIds(e,t){const n=c(t);if("id"===e)return this.data.has(n)?[n]:[];const r=this.indices[e];if(!r)throw new Error(`Requested key ${e} not indexed`);const i=r.get(n);return i?[...i]:[]}internalCheckDuplicates(e,t){if(t&&this.data.has(e.id))throw new Error("duplicate");Object.keys(this.keys).forEach(t=>{const n=this.indices[t];if(this.isIndexUnique(t)&&n.has(e[t]))throw new Error("duplicate")})}internalPopulateIndices(e){Object.keys(this.keys).forEach(t=>{const n=this.indices[t],r=e[t];let i=n.get(r);i||(i=new Set,n.set(r,i)),i.add(e.id)})}internalRemoveIndices(e){Object.keys(this.keys).forEach(t=>{const n=this.indices[t],r=e[t],i=n.get(r);i.delete(e.id),i.size||n.delete(r)})}}function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class g{constructor(e){this.makeCollection=e,m(this,"stateRef",{closed:!1}),m(this,"collectionCache",new Map)}getCollection(e,t){const n=this.collectionCache.get(e),r=(i=t)?`{${Object.keys(i).sort().map(e=>`${JSON.stringify(e)}:${JSON.stringify(i[e])}`).join(",")}}`:"null";var i;if(n){const[t,i]=n;if(r!==t)throw new Error(`Cannot requuest collection '${e}' with different keys`);return i}const s=this.makeCollection(e,t);return this.collectionCache.set(e,[r,s]),s}close(){if(this.stateRef.closed)return;this.syncClose();const e=[...this.collectionCache.values()].map(([,e])=>{var t,n;return null===(t=(n=e).internalReady)||void 0===t?void 0:t.call(n)});return Promise.allSettled(e).then(()=>this.internalClose())}syncClose(){this.stateRef.closed=!0}internalClose(){}}const E=function(e,t){const n=global[e];return n||(global[e]=t,t)}("collectionStorageInMemory",new Map);class O extends g{constructor({simulatedLatency:e=0}={}){super((t,n)=>new b(n,e,this.stateRef))}static connect(e){const t=new r.URL(e),n=t.hostname;if(n&&E.has(n))return E.get(n);const i=t.searchParams,s=Number(i.get("simulatedLatency")),a=new O({simulatedLatency:s});return n&&E.set(n,a),a}getCollection(e,t){return super.getCollection(e,t)}close(){this.syncClose()}}class C extends g{constructor(e,t){super((e,n)=>new t(this.client.db().collection(function(e){return encodeURIComponent(e)}(e)),n,this.stateRef)),this.client=e}static async connect(e){const{MongoClient:t}=await Promise.resolve().then(()=>n(3)),{default:r}=await Promise.resolve().then(()=>n(10)),i=await t.connect(e,{useNewUrlParser:!0,useUnifiedTopology:!0});return new C(i,r)}getCollection(e,t){return super.getCollection(e,t)}getDb(){return this.client.db()}internalClose(){return this.client.close()}}class j{constructor(e,t,n=Number.POSITIVE_INFINITY){this.aws=e,this.fn=t,this.pageLimit=n}batched(e){return this.aws.do(async()=>{let t;for(let n=0;n<this.pageLimit;n+=1){const[n,r]=await this.fn(t);if(await e(n),t=r,!t)return}throw new Error("Too many items")})}async all(){const e=[];return await this.batched(t=>{e.push(...t)}),e}}class T extends Error{constructor(e,t,n){super(`AWS error ${e}; type: ${t}; message: ${n}`),this.status=e,this.type=t}static isType(e,t){return e instanceof T&&e.isType(t)||e instanceof Error&&e.message===t}isType(e){return this.type.endsWith("#"+e)||this.type===e}isTransient(){return this.status>=500||this.type.endsWith("#LimitExceededException")||this.type.endsWith("#ProvisionedThroughputExceededException")||this.type.endsWith("#RequestLimitExceeded")||this.type.endsWith("#ThrottlingException")}}var v=n(2);function S(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function I(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?S(Object(n),!0).forEach((function(t){P(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):S(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function P(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const x=/^([^:]*):\/\/dynamodb\.([^.]+)\.amazonaws\.com(\/?.*)$/;function A(e){return e.length?e:void 0}function k(e,t){return t.map(t=>JSON.stringify(e[t])).join()}function R(e){let t=0;const n={},r={};let i=!1,s=!1;const a={};return Object.keys(e).forEach(o=>{const{attributeExpression:c,joiner:l,attributes:u}=e[o],h=[],d=!Array.isArray(u),p=Array.isArray(u)?u:Object.keys(u);p.length&&(p.forEach(e=>{const i="#"+t,s=":"+t;h.push(c(i,s)),r[i]=e,d&&(n[s]=u[e]),t+=1}),a[o]="string"==typeof l?h.join(l):l(h),s=s||d,i=!0)}),i?I(I({},a),{},{ExpressionAttributeValues:s?n:void 0,ExpressionAttributeNames:r}):{}}const N=e=>({attributeExpression:e=>e,joiner:",",attributes:e||[]}),D=Object(v.a)(e=>T.isType(e,"ResourceNotFoundException")||"pending"===e.message,{timeoutMillis:6e4,maxDelayMillis:1e3,jitter:!1}),$=Object(v.a)(e=>"remaining unprocessed items"===e.message),K=/[^-a-zA-Z0-9_.]/g;function U(e){return e.replace(K,e=>{const t=e.charCodeAt(0).toString(16);return t.length<=2?"_u"+t.padStart(2,"0"):"_U"+t.padStart(4,"0")}).padEnd(3,"_")}function B(e){const t=new Map;return e.forEach(e=>e.forEach(({attributeName:e,attributeType:n})=>{if(t.has(e)){if(t.get(e)!==n)throw new Error("inconsistent attribute type for "+e)}else t.set(e,n)})),[...t.entries()].map(([e,t])=>({AttributeName:e,AttributeType:t}))}function q(e){return{IndexName:e.indexName,KeySchema:e.keySchema.map(({attributeName:e,keyType:t})=>({AttributeName:e,KeyType:t})),Projection:{ProjectionType:e.projectionType||(e.nonKeyAttributes?"INCLUDE":"KEYS_ONLY"),NonKeyAttributes:e.nonKeyAttributes},ProvisionedThroughput:e.throughput}}function _(e,t){return e.keySchema.length===t.KeySchema.length&&e.keySchema.every((e,n)=>e.attributeName===t.KeySchema[n].AttributeName&&e.keyType===t.KeySchema[n].KeyType)}class L{constructor(e,t,{consistentRead:n=!1}={}){this.aws=e,this.host=t,P(this,"region",void 0),P(this,"consistentRead",void 0),P(this,"totalCapacityUnits",0);const r=x.exec(t);r?[,this.region]=r:this.region="us-east-1",this.consistentRead=n}getConsumedUnits(){return this.totalCapacityUnits}getTableNames(){return new j(this.aws,async e=>{const t=await this.call("ListTables",{ExclusiveStartTableName:e});return[t.TableNames,t.LastEvaluatedTableName]},10)}upsertTable(e,t,n=[],r,i){return this.aws.do(async()=>{let s=!1;try{await this.call("CreateTable",{TableName:e,AttributeDefinitions:B([t,...n.map(({keySchema:e})=>e)]),KeySchema:t.map(({attributeName:e,keyType:t})=>({AttributeName:e,KeyType:t})),GlobalSecondaryIndexes:A(n.map(e=>q(e))),BillingMode:i?"PROVISIONED":"PAY_PER_REQUEST",ProvisionedThroughput:i}),s=!0}catch(t){if(!T.isType(t,"ResourceInUseException"))throw t;await this.replaceIndices(e,n)}return r&&await this.waitForTable(e,!0),s})}describeTable(e){return this.call("DescribeTable",{TableName:e})}waitForTable(e,t){return D(async()=>{const n=await this.describeTable(e);if("ACTIVE"!==n.Table.TableStatus)throw new Error("pending");const r=n.Table.GlobalSecondaryIndexes;if(t&&r&&r.some(e=>"ACTIVE"!==e.IndexStatus))throw new Error("pending")})}async deleteTable(e){await this.call("DeleteTable",{TableName:e})}async putItem(e,t,n){await this.call("PutItem",I(I({TableName:e,Item:t},R({ConditionExpression:{attributeExpression:e=>`attribute_not_exists(${e})`,joiner:" and ",attributes:n?[n]:[]}})),{},{ReturnConsumedCapacity:"TOTAL"}))}async updateItem(e,t,n,r){await this.call("UpdateItem",I(I({TableName:e,Key:t},R({UpdateExpression:{attributeExpression:(e,t)=>`${e}=${t}`,joiner:e=>"SET "+e.join(","),attributes:n},ConditionExpression:{attributeExpression:(e,t)=>`${e}=${t}`,joiner:" and ",attributes:r||{}}})),{},{ReturnConsumedCapacity:"TOTAL"}))}async getItem(e,t,n){const r=await this.call("GetItem",I(I({TableName:e,Key:t},R({ProjectionExpression:N(n)})),{},{ConsistentRead:this.consistentRead,ReturnConsumedCapacity:"TOTAL"}));return r.Item&&Object.keys(r.Item).length?r.Item:null}async batchGetItems(e,t,n){if(!t.length)return[];if(1===t.length)return[await this.getItem(e,t[0],n)];const r=Object.keys(t[0]),i=null==n?void 0:n.slice();i&&r.forEach(e=>{i.includes(e)||i.push(e)});const s=new Map;t.forEach((e,t)=>s.set(k(e,r),t));const a=t.map(()=>null),o=I(I({},R({ProjectionExpression:N(i)})),{},{ConsistentRead:this.consistentRead});return await this.callBatched(t,100,async t=>{var n;const i=await this.call("BatchGetItem",{RequestItems:{[e]:I(I({},o),{},{Keys:t})},ReturnConsumedCapacity:"TOTAL"});return i.Responses[e].forEach(e=>{const t=s.get(k(e,r));void 0!==t&&(a[t]=e)}),(null===(n=i.UnprocessedKeys[e])||void 0===n?void 0:n.Keys)||[]}),a}batchPutItems(e,t){return this.callBatched(t,25,async t=>((await this.call("BatchWriteItem",{RequestItems:{[e]:t.map(e=>({PutRequest:{Item:e}}))},ReturnConsumedCapacity:"TOTAL"})).UnprocessedItems[e]||[]).map(e=>e.PutRequest.Item))}batchDeleteItems(e,t){return this.callBatched(t,25,async t=>((await this.call("BatchWriteItem",{RequestItems:{[e]:t.map(e=>({DeleteRequest:{Key:e}}))},ReturnConsumedCapacity:"TOTAL"})).UnprocessedItems[e]||[]).map(e=>e.DeleteRequest.Key))}getAllItems(e,t){const n=I(I({TableName:e},R({ProjectionExpression:N(t)})),{},{ConsistentRead:this.consistentRead,ReturnConsumedCapacity:"TOTAL"});return new j(this.aws,async e=>{const t=await this.call("Scan",I(I({},n),{},{ExclusiveStartKey:e}));return[t.Items,t.LastEvaluatedKey]})}async getItemsBySecondaryKey(e,t,n,r,i){const s=["id"],a=[];(r||[]).forEach(e=>{"id"!==e&&(Object.hasOwnProperty.call(n,e)?s.push(e):a.push(e))});const o=I(I({TableName:e,IndexName:t},R({KeyConditionExpression:{attributeExpression:(e,t)=>`${e}=${t}`,joiner:" and ",attributes:n},ProjectionExpression:N(s)})),{},{ConsistentRead:!1,ReturnConsumedCapacity:"TOTAL"});let c;if(i){c=(await this.call("Query",I(I({},o),{},{Limit:1}))).Items}else c=await new j(this.aws,async e=>{const t=await this.call("Query",I(I({},o),{},{ExclusiveStartKey:e}));return[t.Items,t.LastEvaluatedKey]}).all();if(!c.length||r&&!a.length)return c;const l=await this.batchGetItems(e,c.map(({id:e})=>({id:e})),A(a));return c.map((e,t)=>l[t]?I(I({},e),l[t]):null).filter(e=>e)}async deleteItem(e,t){await this.callDelete(e,t,!1)}deleteAndReturnItem(e,t){return this.callDelete(e,t,!0)}async callDelete(e,t,n){return(await this.call("DeleteItem",I(I({TableName:e,Key:t},R({ConditionExpression:{attributeExpression:e=>`attribute_exists(${e})`,joiner:" and ",attributes:[Object.keys(t)[0]]}})),{},{ReturnConsumedCapacity:"TOTAL",ReturnValues:n?"ALL_OLD":void 0}))).Attributes}async replaceIndices(e,t=[]){const n=await this.describeTable(e),r=new Map,i=[],s=n.Table.GlobalSecondaryIndexes||[];for(let e=0;e<s.length;e+=1){const t=s[e];r.set(t.IndexName,t)}for(let e=0;e<t.length;e+=1){const n=t[e],s=r.get(n.indexName);if(s){if(!_(n,s))throw new Error("Cannot change existing index definition "+n.indexName);r.delete(n.indexName)}else i.push(n)}const a=[...r.keys()];for(let t=0;t<a.length;t+=1)await this.call("UpdateTable",{TableName:e,GlobalSecondaryIndexUpdates:[{Delete:{IndexName:a[t]}}]}),await this.waitForTable(e,!1);for(let t=0;t<i.length;t+=1)await this.call("UpdateTable",{TableName:e,AttributeDefinitions:B([i[t].keySchema]),GlobalSecondaryIndexUpdates:[{Create:q(i[t])}]}),await this.waitForTable(e,!1)}callBatched(e,t,n){const r=e.slice();return this.aws.do(()=>$(async()=>{const e=r.slice();for(r.length=0;e.length;){const i=e.splice(0,t),s=await n(i);r.push(...s)}if(r.length)throw new Error("remaining unprocessed items")}))}async call(e,t){const n=(await this.aws.request({method:"POST",url:this.host,region:this.region,service:"dynamodb",headers:{"Content-Type":"application/x-amz-json-1.0","X-Amz-Target":"DynamoDB_20120810."+e},body:t})).json;if(n.ConsumedCapacity){let e;e=Array.isArray(n.ConsumedCapacity)?n.ConsumedCapacity.reduce((e,t)=>e+Number(t.CapacityUnits),0):Number(n.ConsumedCapacity.CapacityUnits),this.totalCapacityUnits+=e}return n}}function W(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},s=Object.keys(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}function M(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function F(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?M(Object(n),!0).forEach((function(t){G(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):M(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function G(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function H(e,t){return n=>{throw T.isType(n,e)?new Error(t):n}}function Y(e,t){return n=>{if(T.isType(n,e))return t();throw n}}const Q=()=>{};function X(e){return{B:u(e).toString("base64")}}function z(e){const t={};return Object.keys(e).forEach(n=>{t[n]=X(e[n])}),t}function V(e){return Object.hasOwnProperty.call(e,"B")}function J(e){if(!e)return null;const t={};return Object.keys(e).forEach(n=>{t[n]=function(e){if(V(e))return h(Buffer.from(e.B,"base64"));throw new Error("unexpected value type from DDB")}(e[n])}),t}function Z(e,t){if(!V(t))throw new Error("unexpected value type from DDB");return{B:Buffer.concat([Buffer.from(e+":","utf8"),Buffer.from(t.B,"base64")]).toString("base64")}}const ee={B:Buffer.from(":").toString("base64")},te=e=>e+".";function ne(e){if(e)return{ReadCapacityUnits:Math.max(1,Math.ceil(e.read)),WriteCapacityUnits:Math.max(1,Math.ceil(e.write))}}function re(e,t){const n={read:0,write:0};let r=!1;return e.forEach(e=>{const i=null==t?void 0:t(e);i&&(r=!0,n.read+=i.read,n.write+=i.write)}),r?n:null}async function ie(e,t,n,r,i){const s=te(t),[a]=await Promise.all([e.upsertTable(t,[{attributeName:"id",attributeType:"B",keyType:"HASH"}],n.map(e=>({indexName:U(e),keySchema:[{attributeName:e,attributeType:"B",keyType:"HASH"}],throughput:ne(null==i?void 0:i(e))})),!0,ne(null==i?void 0:i(null))),r.length?e.upsertTable(s,[{attributeName:"ix",attributeType:"B",keyType:"HASH"}],[],!0,ne(re(r,i))):e.deleteTable(s).catch(Q)]);if(a||!r.length)return;const o=await e.getItem(s,{ix:ee},["unique"]),c=new Set(r),l=[];var u;if(o&&(u=o.unique,Object.hasOwnProperty.call(u,"SS"))&&l.push(...o.unique.SS.filter(e=>!c.delete(e))),c.size){const n=[...c];await e.getAllItems(t,["id",...n]).batched(async t=>{const r=[];return t.forEach(e=>n.forEach(t=>{r.push({ix:Z(t,e[t]),id:e.id})})),e.batchPutItems(s,r)})}else if(!l.length)return;await e.putItem(s,{ix:ee,unique:{SS:r}})}class se extends i.a{constructor(e,t,n={},r){super(n),this.ddb=e,this.tableName=t,G(this,"uniqueKeys",[]);const i=[];Object.entries(n).forEach(([e,t])=>{(null==t?void 0:t.unique)?this.uniqueKeys.push(e):i.push(e)}),this.initAsync(ie(e,t,i,this.uniqueKeys,r))}get internalTableName(){return this.tableName}get internalIndexTableName(){return te(this.tableName)}internalAdd(e){return this.putItem(z(e))}internalUpsert(e,t){const n=z(F({id:e},t)),{id:r}=n,i=W(n,["id"]),s={id:r};return this.updateItem(s,i,s).catch(Y("ConditionalCheckFailedException",()=>this.putItem(n).catch(Y("duplicate id",()=>this.updateItem(s,i,s).catch(H("ConditionalCheckFailedException","Failed to upsert item"))))))}async internalUpdate(e,t,n){let{id:r}=n,i=W(n,["id"]);if("id"===e)await this.updateItem(z({id:t}),z(i)).catch(Y("ConditionalCheckFailedException",Q));else{const n=await this.internalGetAll(e,t,["id"]);await Promise.all(n.map(({id:n})=>this.updateItem(z({id:n}),z(i),z({[e]:t})).catch(Y("ConditionalCheckFailedException",Q))))}}async internalGet(e,t,n){if("id"===e)return J(await this.ddb.getItem(this.tableName,z({id:t}),n));if(!this.isIndexUnique(e)){return J((await this.ddb.getItemsBySecondaryKey(this.tableName,U(e),z({[e]:t}),n,!0))[0])}const r=X(t),i=await this.ddb.getItem(te(this.tableName),{ix:Z(e,r)},["id"]);if(!i)return null;if(!n)return J(await this.ddb.getItem(this.tableName,i));const s={},a=new Set(n);if(a.delete("id")&&Object.assign(s,i),a.delete(e)&&(s[e]=r),a.size){const e=await this.ddb.getItem(this.tableName,i,[...a]);if(!e)return null;Object.assign(s,e)}return J(s)}async internalGetAll(e,t,n){if(!e){return(await this.ddb.getAllItems(this.tableName,n).all()).map(J)}if(this.isIndexUnique(e)){const r=await this.internalGet(e,t,n);return r?[r]:[]}return(await this.ddb.getItemsBySecondaryKey(this.tableName,U(e),z({[e]:t}),n,!1)).map(J)}async internalRemove(e,t){if("id"===e){return await this.deleteItem(z({id:t}))?1:0}const n=await this.internalGetAll(e,t,["id"]);return(await Promise.all(n.map(({id:e})=>this.deleteItem(z({id:e}))))).filter(e=>e).length}async atomicPutUniques(e,t,n,r){if(!n.length)return void await r();const i=te(this.tableName),s=[];try{await async function(e,t,n){const r=(await Promise.allSettled(e.map(async e=>{await n(e),t.push(e)}))).filter(e=>"rejected"===e.status);if(r.length)throw r[0]}(n,s,n=>this.ddb.putItem(i,{ix:Z(n,t[n]),id:e},"ix").catch(H("ConditionalCheckFailedException","duplicate "+n))),await r()}catch(e){throw await this.ddb.batchDeleteItems(i,s.map(e=>({ix:Z(e,t[e])}))).catch(Q),e}}async putItem(e){return this.atomicPutUniques(e.id,e,this.uniqueKeys,()=>this.ddb.putItem(this.tableName,e,"id").catch(H("ConditionalCheckFailedException","duplicate id")))}async updateItem(e,t,n){const r=this.uniqueKeys.filter(e=>Object.hasOwnProperty.call(t,e));if(!r.length)return void await this.ddb.updateItem(this.tableName,e,t,n);const i=await this.ddb.getItem(this.tableName,e,r);if(!i)throw new T(400,"ConditionalCheckFailedException","could not find item to update");const s=r.filter(e=>i[e].B!==t[e].B);await this.atomicPutUniques(e.id,t,s,()=>this.ddb.updateItem(this.tableName,e,t,F(F({},i),n))),await this.ddb.batchDeleteItems(te(this.tableName),s.map(e=>({ix:Z(e,i[e])})))}async deleteItem(e){try{if(this.uniqueKeys.length){const t=await this.ddb.deleteAndReturnItem(this.tableName,e);await this.ddb.batchDeleteItems(te(this.tableName),this.uniqueKeys.map(e=>({ix:Z(e,t[e])})))}else await this.ddb.deleteItem(this.tableName,e);return!0}catch(e){if(T.isType(e,"ConditionalCheckFailedException"))return!1;throw e}}}var ae=n(1),oe=n.n(ae),ce=n(7),le=n.n(ce),ue=n(8),he=n.n(ue);class de{constructor(){var e,t,n;e=this,t="inflight",n=new Set,t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}do(e){let t=()=>{};const n=new Promise(e=>{t=e}).then(()=>{this.inflight.delete(n)});return this.inflight.add(n),e().finally(t)}async wait(){const e=[...this.inflight];this.inflight.clear(),await Promise.allSettled(e)}}class pe{constructor(e){var t,n,r;this.capacity=e,t=this,n="storage",r=new Map,n in t?Object.defineProperty(t,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[n]=r}cached(e,t){const n=this.storage.get(e);if(this.storage.delete(e))return this.storage.set(e,n),n;const r=t(e);return this.storage.set(e,r),this.flush(),r}async cachedAsync(e,t){const n=this.storage.get(e);if(this.storage.delete(e))return this.storage.set(e,n),n;const r=await t(e);return this.storage.set(e,r),this.flush(),r}remove(e){this.storage.delete(e)}flush(){for(;this.storage.size>this.capacity;)this.storage.delete(this.storage.keys().next().value)}}function fe(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function ye(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?fe(Object(n),!0).forEach((function(t){we(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):fe(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function we(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const be=Buffer.alloc(0),me=/(-|:|\.[0-9]*)/g,ge="AWS4-HMAC-SHA256",Ee=Object(v.a)(e=>!(e instanceof T)||e.isTransient());function Oe(e){const t=Object(ae.createHash)("sha256");return t.update(e),t.digest("hex")}function Ce(e,t){const n=Object(ae.createHmac)("sha256",e);return n.update(t,"utf8"),n.digest()}class je{constructor(e,t){this.keyID=e,we(this,"baseKey",void 0),we(this,"keyCacheDate",new pe(1)),we(this,"keyCacheRegion",new pe(4)),we(this,"keyCache",new pe(16)),we(this,"inflight",new de),we(this,"closed",!1),this.baseKey=Buffer.from("AWS4"+t,"utf8")}do(e){return this.inflight.do(e)}request({method:e,url:t,region:n,service:r,headers:i={},body:s=be,date:a=new Date}){const o=t instanceof URL?t:new URL(t);if(o.search)throw new Error("AWS urls with query strings are not supported");if(this.closed)throw new Error("connection closed");let c;c=s instanceof Buffer?s:"string"==typeof s?Buffer.from(s,"utf8"):Buffer.from(JSON.stringify(s),"utf8");const l=a.toISOString().replace(me,""),u=l.substr(0,8),h=`${u}/${n}/${r}/aws4_request`,d=this.getKey(u,n,r),p=encodeURI(encodeURI(decodeURI(o.pathname)))||"/",f=ye(ye({},i),{},{Host:o.host,"X-Amz-Date":l}),y=Object.keys(f).map(e=>e.toLowerCase()).sort(),w=y.map(e=>`${e}:${f[e]}\n`).join(""),b=y.join(";"),m=[e,p,"",w,b,Oe(c)].join("\n"),g=Ce(d,[ge,l,h,Oe(Buffer.from(m,"utf8"))].join("\n")).toString("hex");return f.Authorization=[`${ge} Credential=${this.keyID}/${h}`,"SignedHeaders="+b,"Signature="+g].join(", "),delete f.Host,this.fetch(o,c,{method:e,headers:f})}async close(){this.closed||(await this.inflight.wait(),this.closed=!0)}fetch(e,t,n){if(this.closed)throw new Error("connection closed");const r="https"===e.protocol?le.a:he.a;return this.inflight.do(()=>Ee(()=>new Promise((i,s)=>{const a=r.request(e,n,e=>{const t=[];e.on("data",e=>t.push(e)),e.on("end",()=>{try{const n=Buffer.concat(t).toString("utf8");t.length=0;const r=JSON.parse(n);!e.statusCode||e.statusCode>=300?s(new T(e.statusCode||0,r.__type,r.message)):i({status:e.statusCode,json:r})}catch(e){s(e)}})});a.on("error",s),a.write(t),a.end()})))}getKey(e,t,n){return this.keyCache.cached(`${e}/${t}/${n}`,()=>{const r=this.keyCacheRegion.cached(`${e}/${t}`,()=>Ce(this.keyCacheDate.cached(e,()=>Ce(this.baseKey,e)),t));return Ce(Ce(r,n),"aws4_request")})}}class Te extends g{constructor(e,t,n,r){super((e,t)=>new se(this.ddb,n+U(e),t,null==r?void 0:r.bind(null,e))),this.aws=e,this.ddb=t}static connect(e,t){const n=new URL(e);let r,i;if(n.username?(r=n.username,i=n.password):(r=process.env.AWS_ACCESS_KEY_ID,i=process.env.AWS_SECRET_ACCESS_KEY),!r||!i)throw new Error("No AWS key / secret specified");const s="false"===n.searchParams.get("tls")?"http":"https",a="true"===n.searchParams.get("consistentRead"),o=n.pathname.substr(1),c=new je(r,i),l=new L(c,`${s}://${n.host}`,{consistentRead:a});return new Te(c,l,o,t||(u=n.searchParams,(e,t)=>{let n=null;if(n=t?u.get(`provision_${e}_index_${t}`)||u.get(`provision_${e}_index`)||u.get("provision_"+e)||u.get("provision"):u.get("provision_"+e)||u.get("provision"),!n||"-"===n)return null;const r=n.split(".");if(2!==r.length)throw new Error(`unexpected provisioning format for ${e} ${t||""}: ${n} (expected 'read.write' or '-')`);return{read:Number.parseInt(r[0],10),write:Number.parseInt(r[1],10)}}));var u}getCollection(e,t){return super.getCollection(e,t)}getDDB(){return this.ddb}internalClose(){return this.aws.close()}}function ve(e,...t){let n=e.map(e=>e.trim()).join(" ");return t.forEach((e,t)=>{n=n.replace(new RegExp(`\\$${e}\\b`,"g"),`ARGV[${t+1}]`)}),n}function Se(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},s=Object.keys(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}function Ie(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Pe(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ie(Object(n),!0).forEach((function(t){xe(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ie(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function xe(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const Ae=e=>void 0!==e;function ke(e,t){return e.filter(({key:e})=>t[e]).map(({key:e,prefix:n})=>`${n}:${t[e]}`)}function Re(e,t){if(!t)return e;const n={};for(let r=0;r<t.length;r+=1)n[t[r]]=e[r];return n}function Ne(e){return Object.values(e).some(e=>null!==e)}async function De(e){await e.unwatch()}async function $e(e,t){const n=[];for(let r=0;r<e.length;r+=1)n.push(await t(e[r]));return n}class Ke extends i.a{constructor(e,t,n={}){super(n),this.pool=e,this.prefix=t,xe(this,"keyPrefixes",{}),xe(this,"uniqueKeys",[]),xe(this,"nonUniqueKeys",[]),Object.keys(n).forEach(e=>{const r=e,i=`${t}-${r}`;this.keyPrefixes[r]=i;const s={key:r,prefix:i};n[r].unique?this.uniqueKeys.push(s):this.nonUniqueKeys.push(s)})}internalAdd(e){const t=d(e);return this.pool.withConnection(async e=>{if(!await this.runAdd(e,t,!1))throw new Error("duplicate")})}internalUpdate(e,t,n,{upsert:r}){const i=d(n),s=c(t);return"id"===e?this.pool.retryWithConnection(async e=>{const t=await this.getUpdatePatch(e,s,i);if(t)await this.runUpdates(e,[t]);else if(r){const t=Pe(Pe({},i),{},{id:s});if(!await this.runAdd(e,t,!0))throw new Error("duplicate")}},De):this.pool.retryWithConnection(async t=>{const n=await this.getAndWatchBySerialisedKey(t,e,s),r=(await $e(n,e=>this.getUpdatePatch(t,e,i))).filter(Ae);await this.runUpdates(t,r)},De)}internalGet(e,t,n){const r=c(t);return this.pool.retryWithConnection(async t=>{var i;const s=(await this.getAndWatchBySerialisedKey(t,e,r))[0];if(void 0===s)return null;return null!==(i=(await this.getByKeysKeepWatches(t,[s],n))[0])&&void 0!==i?i:null},De)}internalGetAll(e,t,n){return this.pool.retryWithConnection(async r=>{let i;if(e){const n=c(t);i=await this.getAndWatchBySerialisedKey(r,e,n)}else{i=await r.keys(this.makeKey("*"));const e=this.prefix.length+1;i=i.map(t=>t.substr(e))}return this.getByKeysKeepWatches(r,i,n)},De)}internalRemove(e,t){const n=c(t),r=Object.keys(this.keys);return r.push("id"),this.pool.retryWithConnection(async t=>{const i=await this.getAndWatchBySerialisedKey(t,e,n),s=(await $e(i,e=>this.rawByKeyKeepWatches(t,e,r))).filter(Ae);if(0===s.length)return 0;const a=t.multi();return s.forEach(e=>{const t=ke(this.uniqueKeys,e),n=ke(this.nonUniqueKeys,e);a.remove(1+t.length+n.length,this.makeKey(e.id),...t,...n,e.id)}),await a.exec(),s.length},De)}makeKey(e){return`${this.prefix}:${e}`}async runAdd(e,t,n){let{id:r}=t,i=Se(t,["id"]);const s=ke(this.uniqueKeys,i),a=ke(this.nonUniqueKeys,i),o=1+s.length+a.length,c=[this.makeKey(r),...s,...a,s.length,"id",r,...Object.entries(i).flat()];if(!n)return Boolean(await e.add(o,...c));const l=await e.multi().add(o,...c).exec();if(!l)throw new Error("transient error");return Boolean(l[0][1])}async getUpdatePatch(e,t,n){await e.watch(this.makeKey(t));const r=await this.rawByKeyKeepWatches(e,t,Object.keys(this.keys).filter(e=>n[e]));if(!r)return;const i=Pe({},n);return Object.keys(i).forEach(e=>{r[e]===i[e]&&(delete i[e],delete r[e])}),{sId:t,newSerialised:i,oldSerialised:r}}async runUpdates(e,t){const n=t.map(e=>this.makeUpdateArgs(e)).filter(Ae);if(!n.length)return;if(1===n.length){const t=await e.multi().update(n[0][0],n[0][1]).exec();if(!t)throw new Error("transient error");if(!t[0][1])throw new Error("duplicate");return}if((await $e(n,t=>e.checkUpdate(t[0],t[1]))).some(e=>!e))throw new Error("duplicate");let r=e.multi();n.forEach(e=>{r=r.updateWithoutCheck(e[0],e[1])});if(!await r.exec())throw new Error("transient error")}makeUpdateArgs({sId:e,oldSerialised:t,newSerialised:n}){const r=Object.entries(n).flat();if(!r.length)return;const i=ke(this.uniqueKeys,n),s=ke(this.nonUniqueKeys,n),a=ke(this.uniqueKeys,t),o=ke(this.nonUniqueKeys,t);if(a.length!==i.length||o.length!==s.length)throw new Error("unexpected key mismatch with old value");return[1+2*(i.length+s.length),[this.makeKey(e),...i,...s,...a,...o,i.length,i.length+s.length,e,...r]]}async getByKeysKeepWatches(e,t,n){const r=await async function(e,t){return t.length?e.multi(t).exec():[]}(e,t.map(e=>this.makeKey(e)).map(e=>n?["hmget",e,...n]:["hgetall",e]));if(!r)throw new Error("transient error");return r.map(([,e])=>Re(e,n)).filter(Ne).map(p)}async rawByKeyKeepWatches(e,t,n){const r=this.makeKey(t);let i;if(n){if(!n.length){return await e.exists(r)?{}:void 0}i=await e.hmget(r,...n)}else i=await e.hgetall(r);const s=Re(i,n);return Ne(s)?s:void 0}async getAndWatchBySerialisedKey(e,t,n){if("id"===t)return[n];const r=this.keyPrefixes[t];if(!r)throw new Error(`Requested key ${t} not indexed`);const i=`${r}:${n}`;return await e.watch(i),e.smembers(i)}}const Ue=ve(['if redis.call("exists",KEYS[1])==1 then',"  return 0","end","for k=2,1+tonumber($uniqueKeyCount) do",'  if redis.call("exists",KEYS[k])==1 then',"    return 0","  end","end",'redis.call("hset",KEYS[1],unpack(ARGV, 2))',"for k=2,#KEYS do",'  redis.call("sadd",KEYS[k],ARGV[3])',"end","return 1"],"uniqueKeyCount"),Be=["for k=2,1+tonumber($uniqueKeyCount) do",'  if redis.call("exists",KEYS[k])==1 then',"    return 0","  end","end"],qe=["local tkc=tonumber($totalKeyCount)",'redis.call("hset",KEYS[1],unpack(ARGV, 4))',"for k=1,tkc do",'  redis.call("smove",KEYS[1+tkc+k],KEYS[1+k],$id)',"end"],_e=ve([...Be,"return 1"],"uniqueKeyCount","totalKeyCount","id"),Le=ve([...qe],"uniqueKeyCount","totalKeyCount","id"),We=ve([...Be,...qe,"return 1"],"uniqueKeyCount","totalKeyCount","id"),Me=ve(['redis.call("del",KEYS[1])',"for k=2,#KEYS do",'  redis.call("srem",KEYS[k],$id)',"end"],"id");function Fe(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const Ge=Object(v.a)(e=>"object"==typeof e&&"transient error"===e.message);class He{constructor(e,t,n,r){this.RedisStatic=e,this.url=t,this.options=n,this.maxConnections=r,Fe(this,"connections",[]),Fe(this,"inUse",0),Fe(this,"queue",[]),Fe(this,"closingFn",void 0),Fe(this,"closed",!1)}async withConnection(e,t){const n=await this.getConnection();try{return await e(n)}finally{await(null==t?void 0:t(n)),this.returnConnection(n)}}async retryWithConnection(e,t){return Ge(()=>this.withConnection(e,t))}close(){return this.closed?Promise.resolve():(this.closed=!0,0===this.inUse?(this.doClose(),Promise.resolve()):new Promise(e=>{this.closingFn=()=>{this.doClose(),e()}}))}doClose(){this.connections.forEach(e=>e.disconnect()),this.connections.length=0}async getConnection(){if(this.closed)throw new Error("Connection closed");const e=this.connections.pop();if(e)return this.inUse+=1,e;if(this.inUse<this.maxConnections){this.inUse+=1;const e=new this.RedisStatic(this.url,this.options);return await e.connect(),function(e){return e.defineCommand("add",{lua:Ue}),e.defineCommand("update",{lua:We}),e.defineCommand("checkUpdate",{lua:_e}),e.defineCommand("updateWithoutCheck",{lua:Le}),e.defineCommand("remove",{lua:Me}),e}(e)}return new Promise(e=>{this.queue.push(e)})}returnConnection(e){const t=this.queue.shift();var n;t?t(e):(this.inUse-=1,this.connections.push(e),0===this.inUse&&(null===(n=this.closingFn)||void 0===n||n.call(this)))}}class Ye extends g{constructor(e){super((e,t)=>new Ke(this.pool,e,t)),this.pool=e}static async connect(e){const{default:t}=await Promise.resolve().then(()=>n(11));return new Ye(new He(t,e,{lazyConnect:!0},5))}getCollection(e,t){return super.getCollection(e,t)}getConnectionPool(){return this.pool}internalClose(){return this.pool.close()}}function Qe(e){return`"${e.replace(/(["\\])/g,"\\$1")}"`}const Xe=/"/g;const ze=/'/g;function Ve(e){return`'${e.replace(ze,"''")}'`}const Je=/\$[A-Z]/g;function Ze(e,t){return e.replace(Je,e=>`"${t[e.substr(1)].replace(Xe,'""')}"`)}function et(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},s=Object.keys(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}const tt={CREATE_TABLE:["CREATE TABLE IF NOT EXISTS $T (","id TEXT NOT NULL PRIMARY KEY,","data HSTORE NOT NULL",")"].join(""),GET_INDEX_NAMES:"SELECT indexname FROM pg_indexes WHERE tablename=$1 AND schemaname=current_schema()",CREATE_INDEX:"CREATE INDEX IF NOT EXISTS $I ON $T USING HASH ((data->$1))",CREATE_UNIQUE_INDEX:"CREATE UNIQUE INDEX IF NOT EXISTS $I ON $T ((data->$1))",DROP_INDEX:"DROP INDEX IF EXISTS $I",INSERT:"INSERT INTO $T (id, data) VALUES ($1, $2::hstore)",UPDATE:"UPDATE $T SET data=data||$1::hstore WHERE data->$2=$3 RETURNING id",UPDATE_ID:"UPDATE $T SET data=data||$1::hstore WHERE id=$2",UPSERT_ID:"INSERT INTO $T (id, data) VALUES ($1, $2::hstore) ON CONFLICT (id) DO UPDATE SET data=$T.data||$2::hstore",SELECT_ONE:"SELECT id, data FROM $T WHERE data->$1=$2 LIMIT 1",SELECT_ALL:"SELECT id, data FROM $T",SELECT_ALL_BY:"SELECT id, data FROM $T WHERE data->$1=$2",SELECT_ID:"SELECT id, data FROM $T WHERE id=$1",DELETE:"DELETE FROM $T WHERE data->$1=$2",DELETE_ID:"DELETE FROM $T WHERE id=$1"};function nt(e){return function(e){const t=[];return Object.keys(e).forEach(n=>{t.push(`${Qe(n)}=>${Qe(e[n])}`)}),t.join(",")}(d(e))}function rt([e,t],n){const r=function(e){const t={};let n="",r="",i=!1;for(let s=0;s<e.length;){const a=e[s];switch(a){case" ":case"\r":case"\n":case"\t":i&&(n+=a);break;case"\\":n+=e[s+1],s+=1;break;case'"':i=!i;break;case"=":i?n+=a:">"===e[s+1]&&(r=n,n="",s+=1);break;case",":i?n+=a:(t[r]=n,r="",n="");break;default:n+=a}s+=1}return r&&(t[r]=n),t}(t);r.id=e;const i={};return n?(n.forEach(e=>{i[e]=l(r[e])}),i):(Object.entries(r).forEach(([e,t])=>{i[e]=l(t)}),i)}class it extends i.a{constructor(e,t,n={},r={closed:!1}){var i,s,a;super(n),this.pool=e,this.tableName=t,this.stateRef=r,a={},(s="cachedQueries")in(i=this)?Object.defineProperty(i,s,{value:a,enumerable:!0,configurable:!0,writable:!0}):i[s]=a,this.initAsync(async function(e,t,n={}){const r=await e.connect();try{await r.query(Ze(tt.CREATE_TABLE,{T:t}));const e=await r.query({rowMode:"array",text:tt.GET_INDEX_NAMES,values:[t]}),i=new Set(e.rows.map(e=>e[0]).filter(e=>e.startsWith(t+"_i")||e.startsWith(t+"_u"))),s=Object.entries(n);for(let e=0;e<s.length;e+=1){const[n,a]=s[e];if(a&&a.unique){const e=`${t}_u${n}`;i.delete(e)||await r.query(Ze(tt.CREATE_UNIQUE_INDEX,{T:t,I:e}).replace(/\$1/g,Ve(n)))}else{const e=`${t}_i${n}`;i.delete(e)||await r.query(Ze(tt.CREATE_INDEX,{T:t,I:e}).replace(/\$1/g,Ve(n)))}}const a=[...i];for(let e=0;e<a.length;e+=1){const n=a[e];await r.query(Ze(tt.DROP_INDEX,{T:t,I:n}))}}finally{r.release()}}(e,t,n))}async internalAdd(e){let{id:t}=e,n=et(e,["id"]);await this.runTableQuery("INSERT",c(t),nt(n))}async internalUpsert(e,t){await this.runTableQuery("UPSERT_ID",c(e),nt(t))}async internalUpdate(e,t,n){let{id:r}=n,i=et(n,["id"]);const s=c(t),a=nt(i);if("id"===e)await this.runTableQuery("UPDATE_ID",a,s);else{const t=await this.runTableQuery("UPDATE",a,e,s);if(void 0!==r&&t.rowCount>0&&t.rows[0][0]!==r)throw new Error("Cannot update ID")}}async internalGet(e,t,n){let r;return r="id"===e?await this.runTableQuery("SELECT_ID",c(t)):await this.runTableQuery("SELECT_ONE",e,c(t)),r.rowCount?rt(r.rows[0],n):null}async internalGetAll(e,t,n){let r;return r=e?"id"===e?await this.runTableQuery("SELECT_ID",c(t)):await this.runTableQuery("SELECT_ALL_BY",e,c(t)):await this.runTableQuery("SELECT_ALL"),r.rows.map(e=>rt(e,n))}async internalRemove(e,t){let n;return n="id"===e?await this.runTableQuery("DELETE_ID",c(t)):await this.runTableQuery("DELETE",e,c(t)),n.rowCount}runTableQuery(e,...t){if(this.stateRef.closed)throw new Error("Connection closed");let n=this.cachedQueries[e];return n||(n=Ze(tt[e],{T:this.tableName}),this.cachedQueries[e]=n),this.pool.query({name:`${this.tableName}_${e}`,rowMode:"array",text:n,values:t})}}class st extends g{constructor(e){super((t,n)=>new it(e,t,n,this.stateRef)),this.pool=e}static async connect(e){const{Pool:t}=await Promise.resolve().then(()=>n(12)),r=new t({connectionString:e});return await r.query("CREATE EXTENSION IF NOT EXISTS hstore"),new st(r)}getCollection(e,t){return super.getCollection(e,t)}getConnectionPool(){return this.pool}internalClose(){return this.pool.end()}}function at(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function ot(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?at(Object(n),!0).forEach((function(t){ct(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):at(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function ct(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function lt(e,t){return t.some(t=>Object.prototype.hasOwnProperty.call(e,t))}class ut{constructor(e,t,n){this.baseCollection=e,this.fields=t,this.wrapper=n}async add(e){return this.baseCollection.add(await this.wrapAll(e))}async get(e,t,n){if(this.fields.includes(e))throw new Error("Cannot get by wrapped value");const r=await this.baseCollection.get(e,t,n);return r?this.unwrapAll(r,{[e]:t}):null}async getAll(e,t,n){if(void 0!==e&&this.fields.includes(e))throw new Error("Cannot get by wrapped value");const r=await this.baseCollection.getAll(e,t,n),i=void 0!==e?{[e]:t}:void 0;return Promise.all(r.map(e=>this.unwrapAll(e,i)))}async update(e,t,n,r){if(this.fields.includes(e))throw new Error("Cannot update by wrapped value");const i=await this.wrapAll(n,{[e]:t});return this.baseCollection.update(e,t,i,r)}async remove(e,t){if(this.fields.includes(e))throw new Error("Cannot remove by wrapped value");if(!this.wrapper.preRemove)return this.baseCollection.remove(e,t);const n=await this.baseCollection.getAll(e,t,["id"]);return await Promise.all(n.map(async e=>{await this.wrapper.preRemove(e),await this.baseCollection.remove("id",e.id)})),n.length}async wrapAll(e,t){let n;if(this.wrapper.preWrap&&lt(e,this.fields)){const r=t?ot(ot({},t),e):e;n=await this.wrapper.preWrap(r)}const r=ot({},e);return await Promise.all(this.fields.map(async t=>{Object.prototype.hasOwnProperty.call(e,t)&&(r[t]=await this.wrapper.wrap(t,e[t],n))})),r}async unwrapAll(e,t){let n;if(this.wrapper.preUnwrap&&lt(e,this.fields)){const r=t?ot(ot({},t),e):e;n=await this.wrapper.preUnwrap(r)}const r=ot({},e);return await Promise.all(this.fields.map(async t=>{Object.prototype.hasOwnProperty.call(e,t)&&(r[t]=await this.wrapper.unwrap(t,e[t],n))})),r}}const ht="aes-256-cbc",dt=Buffer.from(ht+":","utf8");var pt={encrypt:(e,t)=>{const n=oe.a.randomBytes(16),r=oe.a.createCipheriv(ht,e,n),i=r.update(t),s=r.final();return Buffer.concat([dt,n,i,s])},decrypt:(e,t)=>{if(!t.slice(0,dt.length).equals(dt))throw new Error("Unknown encryption algorithm");const n=t.slice(dt.length,dt.length+16),r=t.slice(dt.length+16),i=oe.a.createDecipheriv(ht,e,n),s=i.update(r),a=i.final();return Buffer.concat([s,a])},generateKey:()=>oe.a.createSecretKey(oe.a.randomBytes(32)),serialiseKey:e=>e.export(),deserialiseKey:e=>oe.a.createSecretKey(e)};function ft(e){return(t,n)=>t&&n?e(t,n):e}function yt(e,{encryption:t=pt,allowRaw:n=!1}={}){const r=t.deserialiseKey(e);return ft((e,i)=>new ut(i,e,{wrap:(e,n)=>t.encrypt(r,u(n)),unwrap:async(e,i)=>{if(!(i instanceof Buffer)){if(n)return i;throw new Error("unencrypted data")}return h(await t.decrypt(r,i))}}))}function wt(e,{encryption:t=pt,allowRaw:n=!1,cacheSize:r=0}={}){const i=new pe(r),s=async(n,r)=>{const{id:s}=r;if(void 0===s)throw new Error("Must provide ID for encryption");return i.cachedAsync(s,async()=>{const r=await e.get("id",s,["key"]);if(r)return t.deserialiseKey(r.key);if(!n)throw new Error("No encryption key found for record");const i=await t.generateKey();return await e.add({id:s,key:t.serialiseKey(i)}),i})},a=async({id:t})=>{await e.remove("id",t),i.remove(t)};return ft((e,r)=>new ut(r,e,{wrap:(e,n,r)=>t.encrypt(r,u(n)),unwrap:async(e,r,i)=>{if(!(r instanceof Buffer)){if(n)return r;throw new Error("unencrypted data")}return h(await t.decrypt(i,r))},preWrap:s.bind(null,!0),preUnwrap:s.bind(null,!1),preRemove:a}))}function bt(e,t,n={}){const r=n;return wt(yt(e,r)()(["key"],t),r)}var mt=n(4),gt=n.n(mt),Et=n(5);const Ot=Object(Et.promisify)(gt.a.gzip),Ct=Object(Et.promisify)(gt.a.gunzip),jt=Buffer.of(0);function Tt(e,t,n={}){return new ut(t,e,{wrap:(e,t)=>async function(e,{compressionThresholdBytes:t=200}){const n=u(e);if(n.length>=t){const e=await Ot(n);if(e.length<n.length+1)return e}return Buffer.concat([jt,n])}(t,n),unwrap:(e,t)=>async function(e,{allowRaw:t=!0,allowRawBuffer:n=!1}){if(!(e instanceof Buffer)){if(t)return e;throw new Error("unknown compression type")}if(31===e[0]&&139===e[1])return h(await Ct(e));if(e[0]===jt[0])return h(e.subarray(1));if(t&&n)return e;throw new Error("unknown compression type")}(t,n)})}function vt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function St(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class It{constructor(e,t,n){this.baseCollection=e,this.migrations=t,this.extraFetchFields=n}async add(e){return this.baseCollection.add(e)}async get(e,t,n){const r=await this.baseCollection.get(e,t,this.extendAttributes(n));return r?this.applyMigration(r,n):null}async getAll(e,t,n){return(await this.baseCollection.getAll(e,t,this.extendAttributes(n))).map(e=>this.applyMigration(e,n))}async update(e,t,n,r){return this.baseCollection.update(e,t,n,r)}async remove(e,t){return this.baseCollection.remove(e,t)}extendAttributes(e){return e&&this.extraFetchFields?[...e,...this.extraFetchFields]:e}applyMigration(e,t){if(t&&!t.some(e=>this.migrations[e]))return e;const n=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?vt(Object(n),!0).forEach((function(t){St(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):vt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},e);return(t||Object.keys(this.migrations)).forEach(t=>{const r=t,i=this.migrations[r];i&&(n[r]=i(e[r],e))}),n}}var Pt=function(e,t,n){return n?new It(n,t,e):new It(t,e)};t.default=class{static async connect(e){let t;if(e.startsWith("memory"))t=O;else if(e.startsWith("mongodb"))t=C;else if(e.startsWith("dynamodb"))t=Te;else if(e.startsWith("redis"))t=Ye;else{if(!e.startsWith("postgres"))throw new Error("Unsupported database connection string: "+e);t=st}try{return await t.connect(e)}catch(t){throw new Error(`Failed to connect to database "${e}": ${t.message}`)}}}}])}));
//# sourceMappingURL=index.js.map