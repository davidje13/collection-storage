!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("collection-storage",[],t):"object"==typeof exports?exports["collection-storage"]=t():e["collection-storage"]=t()}(global,(function(){return function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=10)}([function(e,t,n){"use strict";function i(e,t,n){e[t]?Object.defineProperty(e,t,{value:n,configurable:!0,enumerable:!0,writable:!0}):e[t]=n}function r(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]}function s(e,t){const n={};return i(n,e,t),n}function a(e,t,n){const r={};return Object.entries(e).forEach(([e,s])=>{const a=t(s),o=n?n(e):e;i(r,o,a)}),r}n.d(t,"c",(function(){return i})),n.d(t,"d",(function(){return r})),n.d(t,"a",(function(){return s})),n.d(t,"b",(function(){return a}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));class i{constructor(e){var t,n,i;i=void 0,(n="keys")in(t=this)?Object.defineProperty(t,n,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[n]=i,this.keys=new Map(Object.entries(e).filter(([,e])=>e))}getIndices(){return["id",...this.keys.keys()]}getUniqueIndices(){return["id",...[...this.keys.entries()].filter(([,e])=>null==e?void 0:e.unique).map(([e])=>e)]}getCustomIndices(){return[...this.keys.keys()]}isIndex(e){return"id"===e||this.keys.has(e)}isUniqueIndex(e){var t;return Boolean("id"===e||(null===(t=this.keys.get(e))||void 0===t?void 0:t.unique))}}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class a{constructor(e){s(this,"indices",void 0),s(this,"internalReady",void 0),s(this,"innerPreAct",void 0),this.innerPreAct=this.preAct.bind(this),this.indices=new i(e)}async add(e){return await this.innerPreAct(),this.internalAdd(e)}async get(e,t,n){if(!this.indices.isIndex(e))throw new Error("No index for "+e);return await this.innerPreAct(),this.internalGet(e,t,n)}async getAll(e,t,n){if(e&&!this.indices.isIndex(e))throw new Error("No index for "+e);return await this.innerPreAct(),this.internalGetAll(e,t,n)}async update(e,t,n,i={}){if("id"===e&&void 0!==n.id&&n.id!==t)throw new Error("Cannot update ID");if(i.upsert){if("id"!==e)throw new Error("Can only upsert by ID, not "+e);let a=n;return Object.prototype.hasOwnProperty.call(n,"id")&&(a=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},n),delete a.id),await this.innerPreAct(),this.internalUpsert(t,a,i)}if(!this.indices.isIndex(e))throw new Error("No index for "+e);if(!this.indices.isUniqueIndex(e)&&Object.keys(n).some(e=>this.indices.isUniqueIndex(e)))throw new Error("duplicate");return await this.innerPreAct(),this.internalUpdate(e,t,n,i)}async remove(e,t){if(!this.indices.isIndex(e))throw new Error("No index for "+e);return await this.innerPreAct(),this.internalRemove(e,t)}async initAsync(e){const t=[],n=()=>new Promise((e,n)=>{t.push([e,n])});this.internalReady=n,this.innerPreAct=async()=>(await n(),this.preAct());try{await e}catch(e){return this.internalReady=()=>Promise.reject(e),this.innerPreAct=()=>{throw e},void t.forEach(t=>t[1](e))}this.internalReady=void 0,this.innerPreAct=this.preAct.bind(this),t.forEach(e=>e[0]())}preAct(){}async internalGet(e,t,n){var i;return null!==(i=(await this.internalGetAll(e,t,n))[0])&&void 0!==i?i:null}internalUpsert(e,t,n){return this.internalUpdate("id",e,t,n)}}},function(e,t){e.exports=require("crypto")},function(e,t,n){"use strict";function i(e){return new Promise(t=>setTimeout(t,e))}t.a=(e,{timeoutMillis:t=6e4,initialDelayMillis:n=20,maxDelayMillis:r=5e3,delayGrowth:s=2,jitter:a=!0}={})=>async o=>{const c=Date.now()+t;let l=n;for(let t=1;;t+=1)try{return await o()}catch(n){if(!e(n))throw n;const o=Math.min(l,r)*(a?Math.random():1);if(l*=s,Date.now()+o>c)throw n.message+=` (timeout after ${t} attempts)`,n;await i(o)}}},function(e,t){e.exports=require("mongodb")},function(e,t){e.exports=require("zlib")},function(e,t){e.exports=require("util")},function(e,t){e.exports=require("url")},function(e,t){e.exports=require("https")},function(e,t){e.exports=require("http")},function(e,t,n){e.exports=n(14)},function(e,t,n){"use strict";n.r(t),n.d(t,"default",(function(){return E}));var i=n(4),r=n(1),s=n(0),a=n(3);const o=/\./g;function c(e){return"id"===e?"_id":"__proto__"===e?"%5F_proto__":encodeURIComponent(e).replace(o,"%2E")}function l(e){return"_id"===e?"id":decodeURIComponent(e)}function u(e){return Boolean(e)&&"object"==typeof e&&Boolean(e._bsontype)}function h(e){if(e instanceof Buffer)return new i.Binary(e);if(u(e))throw new Error("Must use Buffer to provide binary data");return e}function d(e){return u(e)?e.buffer:e}const p=/^.*? index: ([^ ]+) dup key:.*$/;const f=Object(a.a)(e=>e instanceof i.MongoError&&11e3===e.code&&"_id_"===function(e){var t;return(null===(t=p.exec(e.message))||void 0===t?void 0:t[1])||""}(e));function y(e){return Object(s.b)(e,h,c)}function w(e){return e?Object(s.b)(e,d,l):null}function m(e,t){return Object(s.a)(c(e),{$eq:h(t)})}function b(e){const t={};return e&&(t._id=0,e.forEach(e=>Object(s.c)(t,c(e),1))),t}async function g(e,t={}){const n=await e.indexes().catch(()=>[]),i=[],r=new Set(n.map(e=>e.name));r.delete("_id_"),Object.entries(t).map(([e,t])=>function(e,t={}){const n=Boolean(t.unique);return{key:Object(s.a)(c(e),n?1:"hashed"),unique:n}}(e,t)).forEach(e=>{const t=n.find(t=>function(e,t){if(Boolean(e.unique)!==Boolean(t.unique))return!1;const n=Object.entries(e.key);return Object.keys(t.key).length===n.length&&n.every(([e,n])=>n===Object(s.d)(t.key,e))}(t,e));t?r.delete(t.name):i.push(e)}),i.length&&await e.createIndexes(i),r.size&&await Promise.all([...r].map(t=>e.dropIndex(t)))}class E extends r.a{constructor(e,t={},n={closed:!1}){super(t),this.collection=e,this.stateRef=n,this.initAsync(g(e,t))}preAct(){if(this.stateRef.closed)throw new Error("Connection closed")}async internalAdd(e){await this.collection.insertOne(y(e))}async internalUpsert(e,t){await f(()=>this.collection.updateOne(m("id",e),{$set:y(t)},{upsert:!0}))}async internalUpdate(e,t,n){const i=m(e,t),r={$set:y(n)};try{this.indices.isUniqueIndex(e)?await this.collection.updateOne(i,r):await this.collection.updateMany(i,r)}catch(e){throw e.message.includes("would modify the immutable field '_id'")?new Error("Cannot update ID"):e}}async internalGet(e,t,n){return w(await this.collection.findOne(m(e,t),{projection:b(n)}))}async internalGetAll(e,t,n){const i=this.collection.find(e?m(e,t):{},{projection:b(n)}),r=[];return await i.forEach(e=>r.push(w(e))),r}async internalRemove(e,t){return(await this.collection.deleteMany(m(e,t))).deletedCount||0}}},function(e,t){e.exports=require("ioredis")},function(e,t){e.exports=require("pg")},function(e,t,n){"use strict";n.r(t),n.d(t,"MemoryDb",(function(){return C})),n.d(t,"MongoDb",(function(){return v})),n.d(t,"RedisDb",(function(){return He})),n.d(t,"LruCache",(function(){return we})),n.d(t,"WrappedCollection",(function(){return ct})),n.d(t,"encryptByKey",(function(){return bt})),n.d(t,"encryptByRecord",(function(){return gt})),n.d(t,"encryptByRecordWithMasterKey",(function(){return Et})),n.d(t,"compress",(function(){return xt})),n.d(t,"migrate",(function(){return Nt})),n.d(t,"nodeEncryptionSync",(function(){return ht}));var i=n(7),r=n(1),s=n(0);const a="b".charCodeAt(0),o="s".charCodeAt(0),c=Uint8Array.of(a);function l(e){return e instanceof Buffer?"B"+e.toString("base64"):"string"==typeof e?"s"+e:"boolean"==typeof e?e?"t":"f":null===e?"n":"J"+JSON.stringify(e)}function u(e){const t=e[0],n=e.substr(1);switch(t){case"B":return Buffer.from(n,"base64");case"s":return n;case"t":return!0;case"f":return!1;case"n":return null;case"J":return JSON.parse(n);default:if('{["0123456789-'.includes(t))return JSON.parse(e);throw new Error("Unknown data type "+t)}}function h(e){return e instanceof Buffer?Buffer.concat([c,e]):Buffer.from(l(e),"utf8")}function d(e){if("string"==typeof e)return u(e);const t=e[0];return t===a?e.subarray(1):t===o?e.subarray(1).toString("utf8"):u(e.toString("utf8"))}function p(e){return new Map(Object.entries(e).map(([e,t])=>[e,l(t)]))}function f(e){const t={};return e.forEach((e,n)=>Object(s.c)(t,n,u(e))),t}function y(e,t){if(!t)return f(e);const n={};return t.forEach(t=>{const i=e.get(t);i&&Object(s.c)(n,t,u(i))}),n}function w(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function m(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?w(Object(n),!0).forEach((function(t){b(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):w(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function b(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class g extends r.a{constructor(e={},t=0,n={closed:!1}){super(e),this.simulatedLatency=t,this.stateRef=n,b(this,"data",new Map),b(this,"customIndexData",void 0),b(this,"uniqueIndexDataPtrs",void 0),this.customIndexData=new Map(this.indices.getCustomIndices().map(e=>[e,new Map])),this.uniqueIndexDataPtrs=this.indices.getUniqueIndices().filter(e=>"id"!==e).map(e=>[e,this.customIndexData.get(e)])}preAct(){if(this.stateRef.closed)throw new Error("Connection closed");return function(e){if(e)return new Promise(t=>setTimeout(t,e))}(this.simulatedLatency)}async internalAdd(e){const t=p(e);this.internalCheckDuplicates(t,!0),this.data.set(t.get("id"),t),this.internalPopulateIndices(t)}internalUpsert(e,t){return this.data.has(l(e))?this.internalUpdate("id",e,t):this.internalAdd(m({id:e},t))}async internalUpdate(e,t,n){const i=this.internalGetSerialisedIds(e,t).map(e=>{const t=this.data.get(e),i=f(t),r=m(m({},i),n);if(r.id!==i.id)throw new Error("Cannot update ID");return{oldSerialised:t,newSerialised:p(r)}});i.forEach(({oldSerialised:e})=>this.internalRemoveIndices(e));try{i.forEach(({newSerialised:e})=>this.internalCheckDuplicates(e,!1))}catch(e){throw i.forEach(({oldSerialised:e})=>this.internalPopulateIndices(e)),e}i.forEach(({newSerialised:e})=>{this.data.set(e.get("id"),e),this.internalPopulateIndices(e)})}async internalGetAll(e,t,n){let i;return i=e?this.internalGetSerialisedIds(e,t):[...this.data.keys()],i.map(e=>y(this.data.get(e),n))}async internalRemove(e,t){const n=this.internalGetSerialisedIds(e,t);return n.forEach(e=>{const t=this.data.get(e);this.internalRemoveIndices(t),this.data.delete(e)}),n.length}internalGetSerialisedIds(e,t){const n=l(t);if("id"===e)return this.data.has(n)?[n]:[];const i=this.customIndexData.get(e);if(!i)throw new Error(`Requested key ${e} not indexed`);const r=i.get(n);return r?[...r]:[]}internalCheckDuplicates(e,t){if(t&&this.data.has(e.get("id")))throw new Error("duplicate");this.uniqueIndexDataPtrs.forEach(([t,n])=>{if(n.has(e.get(t)))throw new Error("duplicate")})}internalPopulateIndices(e){const t=e.get("id");this.customIndexData.forEach((n,i)=>{const r=e.get(i);let s=n.get(r);s||(s=new Set,n.set(r,s)),s.add(t)})}internalRemoveIndices(e){const t=e.get("id");this.customIndexData.forEach((n,i)=>{const r=e.get(i),s=n.get(r);s.delete(t),s.size||n.delete(r)})}}function E(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class O{constructor(e){this.makeCollection=e,E(this,"stateRef",{closed:!1}),E(this,"collectionCache",new Map)}getCollection(e,t){const n=this.collectionCache.get(e),i=(r=t)?`{${Object.keys(r).sort().map(e=>`${JSON.stringify(e)}:${JSON.stringify(r[e])}`).join(",")}}`:"null";var r;if(n){const[t,r]=n;if(i!==t)throw new Error(`Cannot requuest collection '${e}' with different keys`);return r}const s=this.makeCollection(e,t);return this.collectionCache.set(e,[i,s]),s}close(){if(this.stateRef.closed)return;this.syncClose();const e=[...this.collectionCache.values()].map(([,e])=>{var t,n;return null===(t=(n=e).internalReady)||void 0===t?void 0:t.call(n)});return Promise.allSettled(e).then(()=>this.internalClose())}syncClose(){this.stateRef.closed=!0}internalClose(){}}const I=function(e,t){const n=global[e];return n||(global[e]=t,t)}("collectionStorageInMemory",new Map);class C extends O{constructor({simulatedLatency:e=0}={}){super((t,n)=>new g(n,e,this.stateRef))}static connect(e){const t=new i.URL(e),n=t.hostname;if(n&&I.has(n))return I.get(n);const r=t.searchParams,s=Number(r.get("simulatedLatency")),a=new C({simulatedLatency:s});return n&&I.set(n,a),a}getCollection(e,t){return super.getCollection(e,t)}close(){this.syncClose()}}class v extends O{constructor(e,t){super((e,n)=>new t(this.client.db().collection(function(e){return encodeURIComponent(e)}(e)),n,this.stateRef)),this.client=e}static async connect(e){const{MongoClient:t}=await Promise.resolve().then(()=>n(4)),{default:i}=await Promise.resolve().then(()=>n(11)),r=await t.connect(e,{useNewUrlParser:!0,useUnifiedTopology:!0});return new v(r,i)}getCollection(e,t){return super.getCollection(e,t)}getDb(){return this.client.db()}internalClose(){return this.client.close()}}class T{constructor(e,t,n=Number.POSITIVE_INFINITY){this.aws=e,this.fn=t,this.pageLimit=n}batched(e){return this.aws.do(async()=>{let t;for(let n=0;n<this.pageLimit;n+=1){const[n,i]=await this.fn(t);if(await e(n),t=i,!t)return}throw new Error("Too many items")})}async all(){const e=[];return await this.batched(t=>{e.push(...t)}),e}}class j extends Error{constructor(e,t,n){super(`AWS error ${e}; type: ${t}; message: ${n}`),this.status=e,this.type=t}static isType(e,t){return e instanceof j&&e.isType(t)||e instanceof Error&&e.message===t}isType(e){return this.type.endsWith("#"+e)||this.type===e}isTransient(){return this.status>=500||this.type.endsWith("#LimitExceededException")||this.type.endsWith("#ProvisionedThroughputExceededException")||this.type.endsWith("#RequestLimitExceeded")||this.type.endsWith("#ThrottlingException")}}var x=n(3);function S(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function P(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?S(Object(n),!0).forEach((function(t){A(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):S(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function A(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const N=/^([^:]*):\/\/dynamodb\.([^.]+)\.amazonaws\.com(\/?.*)$/;function D(e){return e.length?e:void 0}function R(e,t){return t.map(t=>JSON.stringify(e[t])).join()}function k(e){let t=0;const n={},i={};let r=!1,a=!1;const o={};return Object.entries(e).forEach(([e,{attributeExpression:c,joiner:l,attributes:u}])=>{const h=[];if(Array.isArray(u)){if(!u.length)return;u.forEach(e=>{const n="#"+t,r=":"+t;h.push(c(n,r)),Object(s.c)(i,n,e),t+=1})}else{const e=Object.entries(u);if(!e.length)return;e.forEach(([e,r])=>{const a="#"+t,o=":"+t;h.push(c(a,o)),Object(s.c)(i,a,e),Object(s.c)(n,o,r),t+=1}),a=!0}o[e]="string"==typeof l?h.join(l):l(h),r=!0}),r?P(P({},o),{},{ExpressionAttributeValues:a?n:void 0,ExpressionAttributeNames:i}):{}}const K=e=>({attributeExpression:e=>e,joiner:",",attributes:e||[]}),$=Object(x.a)(e=>j.isType(e,"ResourceNotFoundException")||"pending"===e.message,{timeoutMillis:6e4,maxDelayMillis:1e3,jitter:!1}),U=Object(x.a)(e=>"remaining unprocessed items"===e.message),_=/[^-a-zA-Z0-9_.]/g;function q(e){return e.replace(_,e=>{const t=e.charCodeAt(0).toString(16);return t.length<=2?"_u"+t.padStart(2,"0"):"_U"+t.padStart(4,"0")}).padEnd(3,"_")}function B(e){const t=new Map;return e.forEach(e=>e.forEach(({attributeName:e,attributeType:n})=>{if(t.has(e)){if(t.get(e)!==n)throw new Error("inconsistent attribute type for "+e)}else t.set(e,n)})),[...t.entries()].map(([e,t])=>({AttributeName:e,AttributeType:t}))}function L(e){return{IndexName:e.indexName,KeySchema:e.keySchema.map(({attributeName:e,keyType:t})=>({AttributeName:e,KeyType:t})),Projection:{ProjectionType:e.projectionType||(e.nonKeyAttributes?"INCLUDE":"KEYS_ONLY"),NonKeyAttributes:e.nonKeyAttributes},ProvisionedThroughput:e.throughput}}function M(e,t){return e.keySchema.length===t.KeySchema.length&&e.keySchema.every((e,n)=>e.attributeName===t.KeySchema[n].AttributeName&&e.keyType===t.KeySchema[n].KeyType)}class W{constructor(e,t,{consistentRead:n=!1}={}){this.aws=e,this.host=t,A(this,"region",void 0),A(this,"consistentRead",void 0),A(this,"totalCapacityUnits",0);const i=N.exec(t);i?[,this.region]=i:this.region="us-east-1",this.consistentRead=n}getConsumedUnits(){return this.totalCapacityUnits}getTableNames(){return new T(this.aws,async e=>{const t=await this.call("ListTables",{ExclusiveStartTableName:e});return[t.TableNames,t.LastEvaluatedTableName]},10)}upsertTable(e,t,n=[],i,r){return this.aws.do(async()=>{let s=!1;try{await this.call("CreateTable",{TableName:e,AttributeDefinitions:B([t,...n.map(({keySchema:e})=>e)]),KeySchema:t.map(({attributeName:e,keyType:t})=>({AttributeName:e,KeyType:t})),GlobalSecondaryIndexes:D(n.map(e=>L(e))),BillingMode:r?"PROVISIONED":"PAY_PER_REQUEST",ProvisionedThroughput:r}),s=!0}catch(t){if(!j.isType(t,"ResourceInUseException"))throw t;await this.replaceIndices(e,n)}return i&&await this.waitForTable(e,!0),s})}describeTable(e){return this.call("DescribeTable",{TableName:e})}waitForTable(e,t){return $(async()=>{const n=await this.describeTable(e);if("ACTIVE"!==n.Table.TableStatus)throw new Error("pending");const i=n.Table.GlobalSecondaryIndexes;if(t&&i&&i.some(e=>"ACTIVE"!==e.IndexStatus))throw new Error("pending")})}async deleteTable(e){await this.call("DeleteTable",{TableName:e})}async putItem(e,t,n){await this.call("PutItem",P(P({TableName:e,Item:t},k({ConditionExpression:{attributeExpression:e=>`attribute_not_exists(${e})`,joiner:" and ",attributes:n?[n]:[]}})),{},{ReturnConsumedCapacity:"TOTAL"}))}async updateItem(e,t,n,i){await this.call("UpdateItem",P(P({TableName:e,Key:t},k({UpdateExpression:{attributeExpression:(e,t)=>`${e}=${t}`,joiner:e=>"SET "+e.join(","),attributes:n},ConditionExpression:{attributeExpression:(e,t)=>`${e}=${t}`,joiner:" and ",attributes:i||{}}})),{},{ReturnConsumedCapacity:"TOTAL"}))}async getItem(e,t,n){const i=await this.call("GetItem",P(P({TableName:e,Key:t},k({ProjectionExpression:K(n)})),{},{ConsistentRead:this.consistentRead,ReturnConsumedCapacity:"TOTAL"}));return i.Item&&Object.keys(i.Item).length?i.Item:null}async batchGetItems(e,t,n){if(!t.length)return[];if(1===t.length)return[await this.getItem(e,t[0],n)];const i=Object.keys(t[0]),r=null==n?void 0:n.slice();r&&i.forEach(e=>{r.includes(e)||r.push(e)});const a=new Map;t.forEach((e,t)=>a.set(R(e,i),t));const o=t.map(()=>null),c=P(P({},k({ProjectionExpression:K(r)})),{},{ConsistentRead:this.consistentRead});return await this.callBatched(t,100,async t=>{var n;const r=await this.call("BatchGetItem",{RequestItems:Object(s.a)(e,P(P({},c),{},{Keys:t})),ReturnConsumedCapacity:"TOTAL"});return Object(s.d)(r.Responses,e).forEach(e=>{const t=a.get(R(e,i));void 0!==t&&(o[t]=e)}),(null===(n=Object(s.d)(r.UnprocessedKeys,e))||void 0===n?void 0:n.Keys)||[]}),o}batchPutItems(e,t){return this.callBatched(t,25,async t=>{const n=await this.call("BatchWriteItem",{RequestItems:Object(s.a)(e,t.map(e=>({PutRequest:{Item:e}}))),ReturnConsumedCapacity:"TOTAL"});return(Object(s.d)(n.UnprocessedItems,e)||[]).map(e=>e.PutRequest.Item)})}batchDeleteItems(e,t){return this.callBatched(t,25,async t=>{const n=await this.call("BatchWriteItem",{RequestItems:Object(s.a)(e,t.map(e=>({DeleteRequest:{Key:e}}))),ReturnConsumedCapacity:"TOTAL"});return(Object(s.d)(n.UnprocessedItems,e)||[]).map(e=>e.DeleteRequest.Key)})}getAllItems(e,t){const n=P(P({TableName:e},k({ProjectionExpression:K(t)})),{},{ConsistentRead:this.consistentRead,ReturnConsumedCapacity:"TOTAL"});return new T(this.aws,async e=>{const t=await this.call("Scan",P(P({},n),{},{ExclusiveStartKey:e}));return[t.Items,t.LastEvaluatedKey]})}async getItemsBySecondaryKey(e,t,n,i,r){const s=["id"],a=[];(i||[]).forEach(e=>{"id"!==e&&(Object.prototype.hasOwnProperty.call(n,e)?s.push(e):a.push(e))});const o=P(P({TableName:e,IndexName:t},k({KeyConditionExpression:{attributeExpression:(e,t)=>`${e}=${t}`,joiner:" and ",attributes:n},ProjectionExpression:K(s)})),{},{ConsistentRead:!1,ReturnConsumedCapacity:"TOTAL"});let c;if(r){c=(await this.call("Query",P(P({},o),{},{Limit:1}))).Items}else c=await new T(this.aws,async e=>{const t=await this.call("Query",P(P({},o),{},{ExclusiveStartKey:e}));return[t.Items,t.LastEvaluatedKey]}).all();if(!c.length||i&&!a.length)return c;const l=await this.batchGetItems(e,c.map(({id:e})=>({id:e})),D(a));return c.map((e,t)=>l[t]?P(P({},e),l[t]):null).filter(e=>e)}async deleteItem(e,t){await this.callDelete(e,t,!1)}deleteAndReturnItem(e,t){return this.callDelete(e,t,!0)}async callDelete(e,t,n){return(await this.call("DeleteItem",P(P({TableName:e,Key:t},k({ConditionExpression:{attributeExpression:e=>`attribute_exists(${e})`,joiner:" and ",attributes:[Object.keys(t)[0]]}})),{},{ReturnConsumedCapacity:"TOTAL",ReturnValues:n?"ALL_OLD":void 0}))).Attributes}async replaceIndices(e,t=[]){const n=await this.describeTable(e),i=new Map,r=[],s=n.Table.GlobalSecondaryIndexes||[];for(let e=0;e<s.length;e+=1){const t=s[e];i.set(t.IndexName,t)}for(let e=0;e<t.length;e+=1){const n=t[e],s=i.get(n.indexName);if(s){if(!M(n,s))throw new Error("Cannot change existing index definition "+n.indexName);i.delete(n.indexName)}else r.push(n)}const a=[...i.keys()];for(let t=0;t<a.length;t+=1)await this.call("UpdateTable",{TableName:e,GlobalSecondaryIndexUpdates:[{Delete:{IndexName:a[t]}}]}),await this.waitForTable(e,!1);for(let t=0;t<r.length;t+=1)await this.call("UpdateTable",{TableName:e,AttributeDefinitions:B([r[t].keySchema]),GlobalSecondaryIndexUpdates:[{Create:L(r[t])}]}),await this.waitForTable(e,!1)}callBatched(e,t,n){const i=e.slice();return this.aws.do(()=>U(async()=>{const e=i.slice();for(i.length=0;e.length;){const r=e.splice(0,t),s=await n(r);i.push(...s)}if(i.length)throw new Error("remaining unprocessed items")}))}async call(e,t){const n=(await this.aws.request({method:"POST",url:this.host,region:this.region,service:"dynamodb",headers:{"Content-Type":"application/x-amz-json-1.0","X-Amz-Target":"DynamoDB_20120810."+e},body:t})).json;if(n.ConsumedCapacity){let e;e=Array.isArray(n.ConsumedCapacity)?n.ConsumedCapacity.reduce((e,t)=>e+Number(t.CapacityUnits),0):Number(n.ConsumedCapacity.CapacityUnits),this.totalCapacityUnits+=e}return n}}function F(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function G(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?F(Object(n),!0).forEach((function(t){H(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):F(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function H(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function z(e,t){return n=>{throw j.isType(n,e)?new Error(t):n}}function Y(e,t){return n=>{if(j.isType(n,e))return t();throw n}}const Q=()=>{};function X(e){return{B:h(e).toString("base64")}}function V(e){return Object(s.b)(e,X)}function J(e){return Object.prototype.hasOwnProperty.call(e,"B")}function Z(e){if(J(e))return d(Buffer.from(e.B,"base64"));throw new Error("unexpected value type from DDB")}function ee(e){return e?Object(s.b)(e,Z):null}function te(e,t){if(!J(t))throw new Error("unexpected value type from DDB");return{B:Buffer.concat([Buffer.from(e+":","utf8"),Buffer.from(t.B,"base64")]).toString("base64")}}const ne={B:Buffer.from(":").toString("base64")},ie=e=>e+".";function re(e){if(e)return{ReadCapacityUnits:Math.max(1,Math.ceil(e.read)),WriteCapacityUnits:Math.max(1,Math.ceil(e.write))}}function se(e,t){const n={read:0,write:0};let i=!1;return e.forEach(e=>{const r=null==t?void 0:t(e);r&&(i=!0,n.read+=r.read,n.write+=r.write)}),i?n:null}async function ae(e,t,n,i,r){const a=ie(t),[o]=await Promise.all([e.upsertTable(t,[{attributeName:"id",attributeType:"B",keyType:"HASH"}],n.map(e=>({indexName:q(e),keySchema:[{attributeName:e,attributeType:"B",keyType:"HASH"}],throughput:re(null==r?void 0:r(e))})),!0,re(null==r?void 0:r(null))),i.length?e.upsertTable(a,[{attributeName:"ix",attributeType:"B",keyType:"HASH"}],[],!0,re(se(i,r))):e.deleteTable(a).catch(Q)]);if(o||!i.length)return;const c=await e.getItem(a,{ix:ne},["unique"]),l=new Set(i),u=[];var h;if(c&&(h=c.unique,Object.prototype.hasOwnProperty.call(h,"SS"))&&u.push(...c.unique.SS.filter(e=>!l.delete(e))),l.size){const n=[...l];await e.getAllItems(t,["id",...n]).batched(async t=>{const i=[];return t.forEach(e=>n.forEach(t=>{const n=Object(s.d)(e,t);if(!n)throw new Error(`Unable to migrate existing data (no value for ${t})`);i.push({ix:te(t,n),id:e.id})})),e.batchPutItems(a,i)})}else if(!u.length)return;await e.putItem(a,{ix:ne,unique:{SS:i}})}class oe extends r.a{constructor(e,t,n={},i){super(n),this.ddb=e,this.tableName=t,H(this,"uniqueKeys",[]);const r=[];Object.entries(n).forEach(([e,t])=>{null!=t&&t.unique?this.uniqueKeys.push(e):r.push(e)}),this.initAsync(ae(e,t,r,this.uniqueKeys,i))}get internalTableName(){return this.tableName}get internalIndexTableName(){return ie(this.tableName)}internalAdd(e){return this.putItem(V(e))}internalUpsert(e,t){const n=V(G({id:e},t)),i={id:n.id};return delete n.id,this.updateItem(i,n,i).catch(Y("ConditionalCheckFailedException",()=>this.putItem(G(G({},i),n)).catch(Y("duplicate id",()=>this.updateItem(i,n,i).catch(z("ConditionalCheckFailedException","Failed to upsert item"))))))}async internalUpdate(e,t,n){const i=V(n),r=n.id;if(delete i.id,"id"===e)await this.updateItem(V({id:t}),i).catch(Y("ConditionalCheckFailedException",Q));else{const n=await this.internalGetAll(e,t,["id"]);if(!n.length)return;if(r&&(n.length>1||n[0].id!==r))throw new Error("Cannot update ID");const a=V(Object(s.a)(e,t));await Promise.all(n.map(({id:e})=>this.updateItem(V({id:e}),i,a).catch(Y("ConditionalCheckFailedException",Q))))}}async internalGet(e,t,n){if("id"===e)return ee(await this.ddb.getItem(this.tableName,V({id:t}),n));if(!this.indices.isUniqueIndex(e)){return ee((await this.ddb.getItemsBySecondaryKey(this.tableName,q(e),V(Object(s.a)(e,t)),n,!0))[0])}const i=X(t),r=await this.ddb.getItem(ie(this.tableName),{ix:te(e,i)},["id"]);if(!r)return null;if(!n)return ee(await this.ddb.getItem(this.tableName,r));const a={},o=new Set(n);if(o.delete("id")&&Object.assign(a,r),o.delete(e)&&(a[e]=i),o.size){const e=await this.ddb.getItem(this.tableName,r,[...o]);if(!e)return null;Object.assign(a,e)}return ee(a)}async internalGetAll(e,t,n){if(!e){return(await this.ddb.getAllItems(this.tableName,n).all()).map(ee)}if(this.indices.isUniqueIndex(e)){const i=await this.internalGet(e,t,n);return i?[i]:[]}return(await this.ddb.getItemsBySecondaryKey(this.tableName,q(e),V(Object(s.a)(e,t)),n,!1)).map(ee)}async internalRemove(e,t){if("id"===e){return await this.deleteItem(V({id:t}))?1:0}const n=await this.internalGetAll(e,t,["id"]);return(await Promise.all(n.map(({id:e})=>this.deleteItem(V({id:e}))))).filter(e=>e).length}async atomicPutUniques(e,t,n,i){if(!n.length)return void await i();const r=ie(this.tableName),s=[];try{await async function(e,t,n){const i=(await Promise.allSettled(e.map(async e=>{await n(e),t.push(e)}))).filter(e=>"rejected"===e.status);if(i.length)throw i[0].reason}(n,s,n=>this.ddb.putItem(r,{ix:te(n,t[n]),id:e},"ix").catch(z("ConditionalCheckFailedException","duplicate "+n))),await i()}catch(e){throw await this.ddb.batchDeleteItems(r,s.map(e=>({ix:te(e,t[e])}))).catch(Q),e}}async putItem(e){return this.atomicPutUniques(e.id,e,this.uniqueKeys,()=>this.ddb.putItem(this.tableName,e,"id").catch(z("ConditionalCheckFailedException","duplicate id")))}async updateItem(e,t,n){const i=this.uniqueKeys.filter(e=>Object.prototype.hasOwnProperty.call(t,e));if(!i.length)return void await this.ddb.updateItem(this.tableName,e,t,n);const r=await this.ddb.getItem(this.tableName,e,i);if(!r)throw new j(400,"ConditionalCheckFailedException","could not find item to update");const s=i.filter(e=>r[e].B!==t[e].B);await this.atomicPutUniques(e.id,t,s,()=>this.ddb.updateItem(this.tableName,e,t,G(G({},r),n))),await this.ddb.batchDeleteItems(ie(this.tableName),s.map(e=>({ix:te(e,r[e])})))}async deleteItem(e){try{if(this.uniqueKeys.length){const t=await this.ddb.deleteAndReturnItem(this.tableName,e);await this.ddb.batchDeleteItems(ie(this.tableName),this.uniqueKeys.map(e=>({ix:te(e,t[e])})))}else await this.ddb.deleteItem(this.tableName,e);return!0}catch(e){if(j.isType(e,"ConditionalCheckFailedException"))return!1;throw e}}}var ce=n(2),le=n.n(ce),ue=n(8),he=n.n(ue),de=n(9),pe=n.n(de);class fe{constructor(){var e,t,n;e=this,t="inflight",n=new Set,t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}do(e){let t=()=>{};const n=new Promise(e=>{t=e}).then(()=>{this.inflight.delete(n)});return this.inflight.add(n),e().finally(t)}async wait(){const e=[...this.inflight];this.inflight.clear(),await Promise.allSettled(e)}}const ye=()=>!0;class we{constructor(e,t){var n,i,r;this.capacity=e,this.flushFn=t,n=this,i="storage",r=new Map,i in n?Object.defineProperty(n,i,{value:r,enumerable:!0,configurable:!0,writable:!0}):n[i]=r}cached(e,t,n=ye){const i=this.storage.get(e);if(this.storage.delete(e)){var r;if(n(i))return this.storage.set(e,i),i;null===(r=this.flushFn)||void 0===r||r.call(this,i)}const s=t(e);return this.internalAdd(e,s),s}async cachedAsync(e,t,n=ye){const i=this.storage.get(e);if(this.storage.delete(e)){var r;if(n(i))return this.storage.set(e,i),i;null===(r=this.flushFn)||void 0===r||r.call(this,i)}const s=await t(e);return this.internalAdd(e,s),s}add(e,t){this.remove(e),this.internalAdd(e,t)}peek(e){return this.storage.get(e)}remove(e){if(this.flushFn){const t=this.storage.get(e);this.storage.delete(e)&&this.flushFn(t)}else this.storage.delete(e)}clear(){this.storage.clear()}internalAdd(e,t){for(this.storage.set(e,t);this.storage.size>this.capacity;)this.remove(this.storage.keys().next().value)}}function me(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function be(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?me(Object(n),!0).forEach((function(t){ge(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):me(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function ge(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const Ee=Buffer.alloc(0),Oe=/(-|:|\.[0-9]*)/g,Ie="AWS4-HMAC-SHA256",Ce=Object(x.a)(e=>!(e instanceof j)||e.isTransient());function ve(e){const t=Object(ce.createHash)("sha256");return t.update(e),t.digest("hex")}function Te(e,t){const n=Object(ce.createHmac)("sha256",e);return n.update(t,"utf8"),n.digest()}class je{constructor(e,t){this.keyID=e,ge(this,"baseKey",void 0),ge(this,"keyCacheDate",new we(1)),ge(this,"keyCacheRegion",new we(4)),ge(this,"keyCache",new we(16)),ge(this,"inflight",new fe),ge(this,"closed",!1),this.baseKey=Buffer.from("AWS4"+t,"utf8")}do(e){return this.inflight.do(e)}request({method:e,url:t,region:n,service:i,headers:r={},body:s=Ee,date:a=new Date}){const o=t instanceof URL?t:new URL(t);if(o.search)throw new Error("AWS urls with query strings are not supported");if(this.closed)throw new Error("Connection closed");let c;c=s instanceof Buffer?s:"string"==typeof s?Buffer.from(s,"utf8"):Buffer.from(JSON.stringify(s),"utf8");const l=a.toISOString().replace(Oe,""),u=l.substr(0,8),h=`${u}/${n}/${i}/aws4_request`,d=this.getKey(u,n,i),p=encodeURI(encodeURI(decodeURI(o.pathname)))||"/",f=be(be({},r),{},{Host:o.host,"X-Amz-Date":l}),y=Object.keys(f).map(e=>e.toLowerCase()).sort(),w=y.map(e=>`${e}:${f[e]}\n`).join(""),m=y.join(";"),b=[e,p,"",w,m,ve(c)].join("\n"),g=Te(d,[Ie,l,h,ve(Buffer.from(b,"utf8"))].join("\n")).toString("hex");return f.Authorization=[`${Ie} Credential=${this.keyID}/${h}`,"SignedHeaders="+m,"Signature="+g].join(", "),delete f.Host,this.fetch(o,c,{method:e,headers:f})}async close(){this.closed||(await this.inflight.wait(),this.closed=!0)}fetch(e,t,n){if(this.closed)throw new Error("Connection closed");const i="https"===e.protocol?he.a:pe.a;return this.inflight.do(()=>Ce(()=>new Promise((r,s)=>{const a=i.request(e,n,e=>{const t=[];e.on("data",e=>t.push(e)),e.on("end",()=>{try{const n=Buffer.concat(t).toString("utf8");t.length=0;const i=JSON.parse(n);!e.statusCode||e.statusCode>=300?s(new j(e.statusCode||0,i.__type,i.message)):r({status:e.statusCode,json:i})}catch(e){s(e)}})});a.on("error",s),a.write(t),a.end()})))}getKey(e,t,n){return this.keyCache.cached(`${e}/${t}/${n}`,()=>{const i=this.keyCacheRegion.cached(`${e}/${t}`,()=>Te(this.keyCacheDate.cached(e,()=>Te(this.baseKey,e)),t));return Te(Te(i,n),"aws4_request")})}}class xe extends O{constructor(e,t,n,i){super((e,t)=>new oe(this.ddb,n+q(e),t,null==i?void 0:i.bind(null,e))),this.aws=e,this.ddb=t}static connect(e,t){const n=new URL(e);let i,r;if(n.username?(i=n.username,r=n.password):(i=process.env.AWS_ACCESS_KEY_ID,r=process.env.AWS_SECRET_ACCESS_KEY),!i||!r)throw new Error("No AWS key / secret specified");const s="false"===n.searchParams.get("tls")?"http":"https",a="true"===n.searchParams.get("consistentRead"),o=n.pathname.substr(1),c=new je(i,r),l=new W(c,`${s}://${n.host}`,{consistentRead:a});return new xe(c,l,o,t||(u=n.searchParams,(e,t)=>{let n=null;if(n=t?u.get(`provision_${e}_index_${t}`)||u.get(`provision_${e}_index`)||u.get("provision_"+e)||u.get("provision"):u.get("provision_"+e)||u.get("provision"),!n||"-"===n)return null;const i=n.split(".");if(2!==i.length)throw new Error(`unexpected provisioning format for ${e} ${t||""}: ${n} (expected 'read.write' or '-')`);return{read:Number.parseInt(i[0],10),write:Number.parseInt(i[1],10)}}));var u}getCollection(e,t){return super.getCollection(e,t)}getDDB(){return this.ddb}internalClose(){return this.aws.close()}}function Se(e,...t){let n=e.map(e=>e.trim()).join(" ");return t.forEach((e,t)=>{n=n.replace(new RegExp(`\\$${e}\\b`,"g"),`ARGV[${t+1}]`)}),n}function Pe(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const Ae=e=>void 0!==e;function Ne(e,t){return e.filter(({key:e})=>t.has(e)).map(({key:e,prefix:n})=>`${n}:${t.get(e)}`)}function De(e,t){if(!e.length)return;const n=new Map;if(t)t.forEach((t,i)=>{const r=e[i];r&&n.set(t,r)});else for(let t=0;t<e.length;t+=2){const i=e[t],r=e[t+1];r&&n.set(i,r)}return n.size>0?n:void 0}async function Re(e){await e.unwatch()}async function ke(e,t){const n=[];for(let i=0;i<e.length;i+=1)n.push(await t(e[i]));return n}class Ke extends r.a{constructor(e,t,n={}){super(n),this.pool=e,this.prefix=t,Pe(this,"keyPrefixes",new Map),Pe(this,"uniqueKeys",[]),Pe(this,"nonUniqueKeys",[]),this.indices.getCustomIndices().forEach(e=>{const n=`${t}-${e}`;this.keyPrefixes.set(e,n);const i={key:e,prefix:n};this.indices.isUniqueIndex(e)?this.uniqueKeys.push(i):this.nonUniqueKeys.push(i)})}internalAdd(e){const t=p(e);return this.pool.withConnection(async e=>{if(!await this.runAdd(e,t,!1))throw new Error("duplicate")})}internalUpdate(e,t,n,{upsert:i}){const r=p(n),s=l(t);return"id"===e?this.pool.retryWithConnection(async e=>{const t=await this.getUpdatePatch(e,s,r);if(t)await this.runUpdates(e,[t]);else if(i){const t=new Map(r).set("id",s);if(!await this.runAdd(e,t,!0))throw new Error("duplicate")}},Re):this.pool.retryWithConnection(async t=>{const i=await this.getAndWatchBySerialisedKey(t,e,s);if(!i.length)return;if(n.id&&"id"!==e&&(i.length>1||l(n.id)!==i[0]))throw new Error("Cannot update ID");const a=(await ke(i,e=>this.getUpdatePatch(t,e,r))).filter(Ae);await this.runUpdates(t,a)},Re)}internalGet(e,t,n){const i=l(t);return this.pool.retryWithConnection(async t=>{var r;const s=(await this.getAndWatchBySerialisedKey(t,e,i))[0];if(void 0===s)return null;return null!==(r=(await this.getByKeysKeepWatches(t,[s],n))[0])&&void 0!==r?r:null},Re)}internalGetAll(e,t,n){if(e)return this.pool.retryWithConnection(async i=>{const r=l(t),s=await this.getAndWatchBySerialisedKey(i,e,r);return this.getByKeysKeepWatches(i,s,n)},Re);const i=this.prefix.length+1;return this.pool.retryWithConnection(async e=>{const t=e.scanStream({match:this.makeKey("*"),count:100}),r=[];for await(const s of t){const t=s.map(e=>e.substr(i));r.push(...await this.getByKeysKeepWatches(e,t,n))}return r},Re)}internalRemove(e,t){const n=l(t),i=this.indices.getIndices();return this.pool.retryWithConnection(async t=>{const r=await this.getAndWatchBySerialisedKey(t,e,n),s=(await ke(r,e=>this.rawByKeyKeepWatches(t,e,i))).filter(Ae);if(0===s.length)return 0;const a=t.multi();return s.forEach(e=>{const t=e.get("id"),n=Ne(this.uniqueKeys,e),i=Ne(this.nonUniqueKeys,e);a.remove(1+n.length+i.length,this.makeKey(t),...n,...i,t)}),await a.exec(),s.length},Re)}makeKey(e){return`${this.prefix}:${e}`}async runAdd(e,t,n){const i=t.get("id"),r=Ne(this.uniqueKeys,t),s=Ne(this.nonUniqueKeys,t),a=1+r.length+s.length,o=[this.makeKey(i),...r,...s,r.length,"id",i,...[...t.entries()].filter(([e])=>"id"!==e).flat()];if(!n)return Boolean(await e.add(a,...o));const c=await e.multi().add(a,...o).exec();if(!c)throw new Error("transient error");return Boolean(c[0][1])}async getUpdatePatch(e,t,n){await e.watch(this.makeKey(t));const i=await this.rawByKeyKeepWatches(e,t,this.indices.getCustomIndices().filter(e=>n.has(e)));if(!i)return;const r=new Map(n);return n.forEach((e,t)=>{i.get(t)===e&&(r.delete(t),i.delete(t))}),{sId:t,newSerialised:r,oldSerialised:i}}async runUpdates(e,t){const n=t.map(e=>this.makeUpdateArgs(e)).filter(Ae);if(!n.length)return;if(1===n.length){const t=await e.multi().update(n[0][0],n[0][1]).exec();if(!t)throw new Error("transient error");if(!t[0][1])throw new Error("duplicate");return}if((await ke(n,t=>e.checkUpdate(t[0],t[1]))).some(e=>!e))throw new Error("duplicate");let i=e.multi();n.forEach(e=>{i=i.updateWithoutCheck(e[0],e[1])});if(!await i.exec())throw new Error("transient error")}makeUpdateArgs({sId:e,oldSerialised:t,newSerialised:n}){if(!n.size)return;const i=[...n.entries()].flat(),r=Ne(this.uniqueKeys,n),s=Ne(this.nonUniqueKeys,n),a=Ne(this.uniqueKeys,t),o=Ne(this.nonUniqueKeys,t);if(a.length!==r.length||o.length!==s.length)throw new Error("unexpected key mismatch with old value");return[1+2*(r.length+s.length),[this.makeKey(e),...r,...s,...a,...o,r.length,r.length+s.length,e,...i]]}async getByKeysKeepWatches(e,t,n){const i=await async function(e,t){return t.length?e.multi(t).exec():[]}(e,t.map(e=>this.makeKey(e)).map(e=>n?["hmget",e,...n]:["hgetall",e]));if(!i)throw new Error("transient error");return i.map(([,e])=>De(e,n)).filter(Ae).map(f)}async rawByKeyKeepWatches(e,t,n){const i=this.makeKey(t);if(!n)return De(await e.hgetall(i));if(!n.length){return await e.exists(i)?new Map:void 0}return De(await e.hmget(i,...n),n)}async getAndWatchBySerialisedKey(e,t,n){if("id"===t)return[n];const i=this.keyPrefixes.get(t);if(!i)throw new Error(`Requested key ${t} not indexed`);const r=`${i}:${n}`;return await e.watch(r),e.smembers(r)}}const $e=Se(['if redis.call("exists",KEYS[1])==1 then',"  return 0","end","for k=2,1+tonumber($uniqueKeyCount) do",'  if redis.call("exists",KEYS[k])==1 then',"    return 0","  end","end",'redis.call("hset",KEYS[1],unpack(ARGV, 2))',"for k=2,#KEYS do",'  redis.call("sadd",KEYS[k],ARGV[3])',"end","return 1"],"uniqueKeyCount"),Ue=["for k=2,1+tonumber($uniqueKeyCount) do",'  if redis.call("exists",KEYS[k])==1 then',"    return 0","  end","end"],_e=["local tkc=tonumber($totalKeyCount)",'redis.call("hset",KEYS[1],unpack(ARGV, 4))',"for k=1,tkc do",'  redis.call("smove",KEYS[1+tkc+k],KEYS[1+k],$id)',"end"],qe=Se([...Ue,"return 1"],"uniqueKeyCount","totalKeyCount","id"),Be=Se([..._e],"uniqueKeyCount","totalKeyCount","id"),Le=Se([...Ue,..._e,"return 1"],"uniqueKeyCount","totalKeyCount","id"),Me=Se(['redis.call("del",KEYS[1])',"for k=2,#KEYS do",'  redis.call("srem",KEYS[k],$id)',"end"],"id");function We(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const Fe=Object(x.a)(e=>"object"==typeof e&&"transient error"===e.message);class Ge{constructor(e,t,n,i){this.RedisStatic=e,this.url=t,this.options=n,this.maxConnections=i,We(this,"connections",[]),We(this,"inUse",0),We(this,"queue",[]),We(this,"closingFn",void 0),We(this,"closed",!1)}async withConnection(e,t){const n=await this.getConnection();try{return await e(n)}finally{await(null==t?void 0:t(n)),this.returnConnection(n)}}async retryWithConnection(e,t){return Fe(()=>this.withConnection(e,t))}close(){return this.closed?Promise.resolve():(this.closed=!0,0===this.inUse?(this.doClose(),Promise.resolve()):new Promise(e=>{this.closingFn=()=>{this.doClose(),e()}}))}doClose(){this.connections.forEach(e=>e.disconnect()),this.connections.length=0}async getConnection(){if(this.closed)throw new Error("Connection closed");const e=this.connections.pop();if(e)return this.inUse+=1,e;if(this.inUse<this.maxConnections){this.inUse+=1;const e=new this.RedisStatic(this.url,this.options);return await e.connect(),function(e){return e.defineCommand("add",{lua:$e}),e.defineCommand("update",{lua:Le}),e.defineCommand("checkUpdate",{lua:qe}),e.defineCommand("updateWithoutCheck",{lua:Be}),e.defineCommand("remove",{lua:Me}),e}(e)}return new Promise(e=>{this.queue.push(e)})}returnConnection(e){const t=this.queue.shift();var n;t?t(e):(this.inUse-=1,this.connections.push(e),0===this.inUse&&(null===(n=this.closingFn)||void 0===n||n.call(this)))}}class He extends O{constructor(e){super((e,t)=>new Ke(this.pool,e,t)),this.pool=e}static async connect(e){const{default:t}=await Promise.resolve().then(()=>n(12));t.Command.setReplyTransformer("hgetall",e=>e);return new He(new Ge(t,e,{lazyConnect:!0},5))}getCollection(e,t){return super.getCollection(e,t)}getConnectionPool(){return this.pool}internalClose(){return this.pool.close()}}function ze(e){return`"${e.replace(/(["\\])/g,"\\$1")}"`}function Ye(e){const t=[];return e.forEach((e,n)=>{t.push(`${ze(n)}=>${ze(e)}`)}),t.join(",")}const Qe=/"/g;const Xe=/'/g;function Ve(e){return`'${e.replace(Xe,"''")}'`}const Je=/\$[A-Z]/g;function Ze(e,t){return e.replace(Je,e=>`"${t[e.substr(1)].replace(Qe,'""')}"`)}const et={CREATE_TABLE:["CREATE TABLE IF NOT EXISTS $T (","id TEXT NOT NULL PRIMARY KEY,","data HSTORE NOT NULL",")"].join(""),GET_INDEX_NAMES:"SELECT indexname FROM pg_indexes WHERE tablename=$1 AND schemaname=current_schema()",CREATE_INDEX:"CREATE INDEX IF NOT EXISTS $I ON $T USING HASH ((data->$1))",CREATE_UNIQUE_INDEX:"CREATE UNIQUE INDEX IF NOT EXISTS $I ON $T ((data->$1))",DROP_INDEX:"DROP INDEX IF EXISTS $I",INSERT:"INSERT INTO $T (id, data) VALUES ($1, $2::hstore)",UPDATE:"UPDATE $T SET data=data||$1::hstore WHERE data->$2=$3 RETURNING id",UPDATE_IF_ID:"UPDATE $T SET data=data||$1::hstore WHERE data->$2=$3 RETURNING CASE WHEN id<>$4 THEN LENGTH(id)/0 ELSE 1 END",UPDATE_ID:"UPDATE $T SET data=data||$1::hstore WHERE id=$2",UPSERT_ID:"INSERT INTO $T (id, data) VALUES ($1, $2::hstore) ON CONFLICT (id) DO UPDATE SET data=$T.data||$2::hstore",SELECT_ONE:"SELECT id, data FROM $T WHERE data->$1=$2 LIMIT 1",SELECT_ALL:"SELECT id, data FROM $T",SELECT_ALL_BY:"SELECT id, data FROM $T WHERE data->$1=$2",SELECT_ID:"SELECT id, data FROM $T WHERE id=$1",DELETE:"DELETE FROM $T WHERE data->$1=$2",DELETE_ID:"DELETE FROM $T WHERE id=$1"};function tt([e,t],n){return y(function(e){const t=new Map;let n="",i="",r=!1;for(let s=0;s<e.length;){const a=e[s];switch(a){case" ":case"\r":case"\n":case"\t":r&&(n+=a);break;case"\\":n+=e[s+1],s+=1;break;case'"':r=!r;break;case"=":r?n+=a:">"===e[s+1]&&(i=n,n="",s+=1);break;case",":r?n+=a:(t.set(i,n),i="",n="");break;default:n+=a}s+=1}return i&&t.set(i,n),t}(t).set("id",e),n)}class nt extends r.a{constructor(e,t,n={},i={closed:!1}){var r,s,a;super(n),this.pool=e,this.tableName=t,this.stateRef=i,r=this,s="cachedQueries",a=new Map,s in r?Object.defineProperty(r,s,{value:a,enumerable:!0,configurable:!0,writable:!0}):r[s]=a,this.initAsync(async function(e,t,n={}){const i=await e.connect();try{await i.query(Ze(et.CREATE_TABLE,{T:t}));const e=await i.query({rowMode:"array",text:et.GET_INDEX_NAMES,values:[t]}),r=new Set(e.rows.map(e=>e[0]).filter(e=>e.startsWith(t+"_i")||e.startsWith(t+"_u"))),s=Object.entries(n);for(let e=0;e<s.length;e+=1){const[n,a]=s[e];if(a&&a.unique){const e=`${t}_u${n}`;r.delete(e)||await i.query(Ze(et.CREATE_UNIQUE_INDEX,{T:t,I:e}).replace(/\$1/g,Ve(n)))}else{const e=`${t}_i${n}`;r.delete(e)||await i.query(Ze(et.CREATE_INDEX,{T:t,I:e}).replace(/\$1/g,Ve(n)))}}const a=[...r];for(let e=0;e<a.length;e+=1){const n=a[e];await i.query(Ze(et.DROP_INDEX,{T:t,I:n}))}}finally{i.release()}}(e,t,n))}async internalAdd(e){const t=p(e),n=t.get("id");t.delete("id"),await this.runTableQuery("INSERT",n,Ye(t))}async internalUpsert(e,t){await this.runTableQuery("UPSERT_ID",l(e),Ye(p(t)))}async internalUpdate(e,t,n){const i=l(t),r=p(n),s=r.get("id");r.delete("id");const a=Ye(r);if("id"===e)await this.runTableQuery("UPDATE_ID",a,i);else if(void 0!==s)try{await this.runTableQuery("UPDATE_IF_ID",a,e,i,s)}catch(e){throw e.message.includes("division by zero")?new Error("Cannot update ID"):e}else await this.runTableQuery("UPDATE",a,e,i)}async internalGet(e,t,n){let i;return i="id"===e?await this.runTableQuery("SELECT_ID",l(t)):await this.runTableQuery("SELECT_ONE",e,l(t)),i.rowCount?tt(i.rows[0],n):null}async internalGetAll(e,t,n){let i;return i=e?"id"===e?await this.runTableQuery("SELECT_ID",l(t)):await this.runTableQuery("SELECT_ALL_BY",e,l(t)):await this.runTableQuery("SELECT_ALL"),i.rows.map(e=>tt(e,n))}async internalRemove(e,t){let n;return n="id"===e?await this.runTableQuery("DELETE_ID",l(t)):await this.runTableQuery("DELETE",e,l(t)),n.rowCount}runTableQuery(e,...t){if(this.stateRef.closed)throw new Error("Connection closed");let n=this.cachedQueries.get(e);return n||(n=Ze(et[e],{T:this.tableName}),this.cachedQueries.set(e,n)),this.pool.query({name:`${this.tableName}_${e}`,rowMode:"array",text:n,values:t})}}class it extends O{constructor(e){super((t,n)=>new nt(e,t,n,this.stateRef)),this.pool=e}static async connect(e){const{Pool:t}=await Promise.resolve().then(()=>n(13)),i=new t({connectionString:e});return await i.query("CREATE EXTENSION IF NOT EXISTS hstore"),new it(i)}getCollection(e,t){return super.getCollection(e,t)}getConnectionPool(){return this.pool}internalClose(){return this.pool.end()}}function rt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function st(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?rt(Object(n),!0).forEach((function(t){at(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):rt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function at(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function ot(e,t){return t.some(t=>Object.prototype.hasOwnProperty.call(e,t))}class ct{constructor(e,t,n){this.baseCollection=e,this.fields=t,this.wrapper=n,t.forEach(t=>{if(e.indices.isUniqueIndex(t))throw new Error("Cannot wrap unique index "+t)})}async add(e){return this.baseCollection.add(await this.wrapAll(e))}async get(e,t,n){if(this.fields.includes(e))throw new Error("Cannot get by wrapped value");const i=await this.baseCollection.get(e,t,n);return i?this.unwrapAll(i,Object(s.a)(e,t)):null}async getAll(e,t,n){if(void 0!==e&&this.fields.includes(e))throw new Error("Cannot get by wrapped value");const i=await this.baseCollection.getAll(e,t,n),r=void 0!==e?Object(s.a)(e,t):void 0;return Promise.all(i.map(e=>this.unwrapAll(e,r)))}async update(e,t,n,i){if(this.fields.includes(e))throw new Error("Cannot update by wrapped value");const r=await this.wrapAll(n,Object(s.a)(e,t));return this.baseCollection.update(e,t,r,i)}async remove(e,t){if(this.fields.includes(e))throw new Error("Cannot remove by wrapped value");if(!this.wrapper.preRemove)return this.baseCollection.remove(e,t);const n=await this.baseCollection.getAll(e,t,["id"]);return await Promise.all(n.map(async e=>{await this.wrapper.preRemove(e),await this.baseCollection.remove("id",e.id)})),n.length}get indices(){return this.baseCollection.indices}async wrapAll(e,t){let n;if(this.wrapper.preWrap&&ot(e,this.fields)){const i=t?st(st({},t),e):e;n=await this.wrapper.preWrap(i)}const i=st({},e);return await Promise.all(this.fields.map(async t=>{Object.prototype.hasOwnProperty.call(e,t)&&(i[t]=await this.wrapper.wrap(t,e[t],n))})),i}async unwrapAll(e,t){let n;if(this.wrapper.preUnwrap&&ot(e,this.fields)){const i=t?st(st({},t),e):e;n=await this.wrapper.preUnwrap(i)}const i=st({},e);return await Promise.all(this.fields.map(async t=>{Object.prototype.hasOwnProperty.call(e,t)&&(i[t]=await this.wrapper.unwrap(t,e[t],n))})),i}}const lt="aes-256-cbc",ut=Buffer.from(lt+":","utf8");var ht={encrypt:(e,t)=>{const n=le.a.randomBytes(16),i=le.a.createCipheriv(lt,e,n),r=i.update(t),s=i.final();return Buffer.concat([ut,n,r,s])},decrypt:(e,t)=>{if(!t.slice(0,ut.length).equals(ut))throw new Error("Unknown encryption algorithm");const n=t.slice(ut.length,ut.length+16),i=t.slice(ut.length+16),r=le.a.createDecipheriv(lt,e,n),s=r.update(i),a=r.final();return Buffer.concat([s,a])},generateKey:()=>le.a.createSecretKey(le.a.randomBytes(32)),serialiseKey:e=>e.export(),deserialiseKey:e=>le.a.createSecretKey(e)};function dt(e,t){if(null==e)return{};var n,i,r=function(e,t){if(null==e)return{};var n,i,r={},s=Object.keys(e);for(i=0;i<s.length;i++)n=s[i],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(i=0;i<s.length;i++)n=s[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}function pt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function ft(e,t){return!e||e.includes(t)?e:[...e,t]}class yt{constructor(e,{capacity:t=Number.POSITIVE_INFINITY,maxAge:n=Number.POSITIVE_INFINITY,time:i=Date.now}){this.baseCollection=e,pt(this,"maxAge",void 0),pt(this,"time",void 0),pt(this,"cache",void 0),pt(this,"customIndexData",void 0),this.maxAge=n,this.time=i,this.cache=new we(t,this.removeIndices.bind(this)),this.customIndexData=new Map(e.indices.getCustomIndices().map(e=>[e,new Map]))}async add(e){await this.baseCollection.add(e),this.storeItem(p(e),!1)}async get(e,t,n){if("id"===e){const e=await this.cachedById(t,n);return e.serialised?y(e.serialised,n):null}if(this.indices.isUniqueIndex(e)){const i=this.getKeys(e,t);if(i.length){const r=await this.cachedById(u(i[0]),ft(n,e));if(r.serialised&&r.serialised.get(e)===l(t))return y(r.serialised,n)}}const i=await this.baseCollection.get(e,t,ft(n,"id"));return i?this.storeItem(p(i).set(e,l(t)),Boolean(n)):this.getKeys(e,t).forEach(e=>this.cache.remove(e)),i}async getAll(e,t,n){if(!e){const e=await this.baseCollection.getAll();return this.cache.clear(),e.forEach(e=>this.storeItem(p(e),!1)),e}if(this.indices.isUniqueIndex(e)){const i=await this.get(e,t,n);return i?[i]:[]}const i=await this.baseCollection.getAll(e,t,ft(n,"id"));if(this.indices.isIndex(e)){const n=new Set(this.getKeys(e,t));i.forEach(({id:e})=>n.delete(l(e))),n.forEach(e=>this.cache.remove(e))}return n&&!n.includes("id")?i.map(e=>{let{id:t}=e;return dt(e,["id"])}):i}async update(e,t,n,i){await this.baseCollection.update(e,t,n,i);const r=this.getKeys(e,t),s=p(n);r.forEach(e=>{const t=this.cache.peek(e),{serialised:n}=t;n&&(this.removeIndices(t),s.forEach((e,t)=>{n.set(t,e)}),this.populateIndices(t))}),!r.length&&null!=i&&i.upsert&&"id"===e&&this.storeItem(p(n).set("id",l(t)),!0)}async remove(e,t){const n=await this.baseCollection.remove(e,t);return n>0&&this.getKeys(e,t).forEach(e=>{this.cache.add(e,{serialised:null,partial:!1,time:this.time()})}),n}get indices(){return this.baseCollection.indices}getKeys(e,t){var n;const i=l(t);if("id"===e)return[i];const r=null===(n=this.customIndexData.get(e))||void 0===n?void 0:n.get(i);return r?[...r]:[]}populateIndices({serialised:e}){if(!e)return;const t=e.get("id");this.customIndexData.forEach((n,i)=>{const r=e.get(i);if(!r)return;let s=n.get(r);if(s)if(s.size&&this.indices.isUniqueIndex(i)){const e=[...s][0];e!==t&&(this.cache.remove(e),n.set(r,new Set([t])))}else s.add(t);else s=new Set([t]),n.set(r,s)})}removeIndices({serialised:e}){if(!e)return;const t=e.get("id");this.customIndexData.forEach((n,i)=>{const r=e.get(i);if(!r)return;const s=n.get(r);s.delete(t),s.size||n.delete(r)})}storeItem(e,t){const n={serialised:e,partial:t,time:this.time()};this.populateIndices(n),this.cache.add(e.get("id"),n)}cachedById(e,t){const n=l(e);return this.cache.cachedAsync(n,async()=>{const i=await this.baseCollection.get("id",e,t),r={serialised:i?p(i).set("id",n):null,partial:Boolean(t),time:this.time()};return this.populateIndices(r),r},this.isFresh(t))}isFresh(e){return({serialised:t,partial:n,time:i})=>!(this.time()>i+this.maxAge)&&(!t||!n||!!e&&e.every(e=>t.has(e)))}}function wt(e,t){if(null==e)return{};var n,i,r=function(e,t){if(null==e)return{};var n,i,r={},s=Object.keys(e);for(i=0;i<s.length;i++)n=s[i],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(i=0;i<s.length;i++)n=s[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}function mt(e){return(t,n)=>t&&n?e(t,n):e}function bt(e,{encryption:t=ht,allowRaw:n=!1}={}){const i=t.deserialiseKey(e);return mt((e,r)=>new ct(r,e,{wrap:(e,n)=>t.encrypt(i,h(n)),unwrap:async(e,r)=>{if(!(r instanceof Buffer)){if(n)return r;throw new Error("unencrypted data")}return d(await t.decrypt(i,r))}}))}function gt(e,t={}){let{encryption:n=ht,allowRaw:i=!1,keyCache:r}=t;if(wt(t,["encryption","allowRaw","keyCache"]).cacheSize)throw new Error("{ cacheSize: size } is deprecated; use { keyCache: { capacity: size } } instead");r&&(e=function(e,t={}){return void 0!==t.capacity&&t.capacity<=0||void 0!==t.maxAge&&t.maxAge<0?e:new yt(e,t)}(e,r));const s=new we(1024),a=async(t,i)=>{const{id:r}=i;if(void 0===r)throw new Error("Must provide ID for encryption");const a=await e.get("id",r,["key"]);if(a)return s.cached(a.key,()=>n.deserialiseKey(a.key));if(!t)throw new Error("No encryption key found for record");const o=await n.generateKey(),c=n.serialiseKey(o);return await e.add({id:r,key:c}),s.add(c,o),o},o=async({id:t})=>{await e.remove("id",t)};return mt((e,t)=>new ct(t,e,{wrap:(e,t,i)=>n.encrypt(i,h(t)),unwrap:async(e,t,r)=>{if(!(t instanceof Buffer)){if(i)return t;throw new Error("unencrypted data")}return d(await n.decrypt(r,t))},preWrap:a.bind(null,!0),preUnwrap:a.bind(null,!1),preRemove:o}))}function Et(e,t,n={}){const i=n;return gt(bt(e,i)()(["key"],t),i)}var Ot=n(5),It=n.n(Ot),Ct=n(6);const vt=Object(Ct.promisify)(It.a.gzip),Tt=Object(Ct.promisify)(It.a.gunzip),jt=Buffer.of(0);function xt(e,t,n={}){return new ct(t,e,{wrap:(e,t)=>async function(e,{compressionThresholdBytes:t=200}){const n=h(e);if(n.length>=t){const e=await vt(n);if(e.length<n.length+1)return e}return Buffer.concat([jt,n])}(t,n),unwrap:(e,t)=>async function(e,{allowRaw:t=!0,allowRawBuffer:n=!1}){if(!(e instanceof Buffer)){if(t)return e;throw new Error("unknown compression type")}if(31===e[0]&&139===e[1])return d(await Tt(e));if(e[0]===jt[0])return d(e.subarray(1));if(t&&n)return e;throw new Error("unknown compression type")}(t,n)})}function St(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Pt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class At{constructor(e,t,n){this.baseCollection=e,this.extraFetchFields=n,Pt(this,"migrations",void 0),Pt(this,"migratedAttrs",void 0),this.migrations=new Map(Object.entries(t)),this.migratedAttrs=[...this.migrations.keys()]}async add(e){return this.baseCollection.add(e)}async get(e,t,n){const i=await this.baseCollection.get(e,t,this.extendAttributes(n));return i?this.applyMigration(i,n):null}async getAll(e,t,n){return(await this.baseCollection.getAll(e,t,this.extendAttributes(n))).map(e=>this.applyMigration(e,n))}async update(e,t,n,i){return this.baseCollection.update(e,t,n,i)}async remove(e,t){return this.baseCollection.remove(e,t)}get indices(){return this.baseCollection.indices}extendAttributes(e){return e&&this.extraFetchFields?[...e,...this.extraFetchFields]:e}applyMigration(e,t){if(t&&!t.some(e=>this.migrations.has(e)))return e;const n=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?St(Object(n),!0).forEach((function(t){Pt(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):St(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},e);return(t||this.migratedAttrs).forEach(t=>{const i=this.migrations.get(t);i&&(n[t]=i(Object(s.d)(e,t),e))}),n}}var Nt=function(e,t,n){return n?new At(n,t,e):new At(t,e)};t.default=class{static async connect(e){let t;if(e.startsWith("memory"))t=C;else if(e.startsWith("mongodb"))t=v;else if(e.startsWith("dynamodb"))t=xe;else if(e.startsWith("redis"))t=He;else{if(!e.startsWith("postgres"))throw new Error("Unsupported database connection string: "+e);t=it}try{return await t.connect(e)}catch(t){throw new Error(`Failed to connect to database "${e}": ${t.message}`)}}}}])}));
//# sourceMappingURL=index.js.map