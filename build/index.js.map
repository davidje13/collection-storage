{"version":3,"sources":["webpack://websocket-express/webpack/universalModuleDefinition","webpack://websocket-express/webpack/bootstrap","webpack://websocket-express/external \"url\"","webpack://websocket-express/external \"mongodb\"","webpack://websocket-express/./src/memory/MemoryCollection.js","webpack://websocket-express/./src/memory/MemoryDb.js","webpack://websocket-express/./src/mongo/MongoCollection.js","webpack://websocket-express/./src/mongo/MongoDb.js","webpack://websocket-express/./src/index.js","webpack://websocket-express/./src/CollectionStorage.js"],"names":["root","factory","exports","module","define","amd","global","installedModules","__webpack_require__","moduleId","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","require","sleep","millis","Promise","resolve","setTimeout","MemoryCollection","constructor","keys","simulatedLatency","this","data","Map","forEach","set","map","options","internalGetIds","keyName","has","keyInfo","Error","ids","internalCheckDuplicates","checkId","id","unique","internalPopulateIndices","v","Set","add","internalRemoveIndices","delete","length","[object Object]","JSON","stringify","upsert","undefined","assign","oldValue","parse","newValue","e","fields","all","getAll","result","field","applyFilter","globalDbs","MemoryDb","url","parsedUrl","URL","hostname","params","searchParams","Number","db","mapTables","getCollection","MONGO_ID","ID","fieldNameToMongo","convertToMongo","rest","convertFromMongo","makeMongoFields","names","fieldName","MongoCollection","collection","createIndex","insertOne","updateOne","$set","findOne","projection","cursor","mFields","find","raw","push","MongoDb","MongoClient","then","client","connect","useNewUrlParser","__webpack_exports__","MemoryDb_MemoryDb","MongoDb_MongoDb","CollectionStorage","dbClass","startsWith","message"],"mappings":"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","file":"index.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine(\"websocket-express\", [], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"websocket-express\"] = factory();\n\telse\n\t\troot[\"websocket-express\"] = factory();\n})(global, function() {\nreturn "," \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 1);\n","module.exports = require(\"url\");","module.exports = require(\"mongodb\");","function sleep(millis) {\n  if (!millis) {\n    return null;\n  }\n\n  // Simulate data access delays to ensure non-flakey e2e tests, etc.\n  return new Promise((resolve) => setTimeout(resolve, millis));\n}\n\nfunction applyFilter(data, fields) {\n  if (!fields) {\n    return data;\n  }\n  const result = {};\n  fields.forEach((field) => {\n    result[field] = data[field];\n  });\n  return result;\n}\n\nexport default class MemoryCollection {\n  constructor(keys = {}, simulatedLatency = 0) {\n    this.data = new Map();\n    this.keys = new Map();\n    this.simulatedLatency = simulatedLatency;\n\n    Object.keys(keys).forEach((key) => {\n      this.keys.set(key, { map: new Map(), options: keys[key] });\n    });\n  }\n\n  internalGetIds(keyName, key) {\n    if (keyName === 'id') {\n      return this.data.has(key) ? [key] : [];\n    }\n    const keyInfo = this.keys.get(keyName);\n    if (!keyInfo) {\n      throw new Error(`Requested key ${keyName} not indexed`);\n    }\n    const ids = keyInfo.map.get(key);\n    return ids ? [...ids] : []; // convert set to array\n  }\n\n  internalCheckDuplicates(value, checkId) {\n    if (checkId && this.data.has(value.id)) {\n      throw new Error('duplicate');\n    }\n    this.keys.forEach(({ map, options }, key) => {\n      if (options.unique && map.has(value[key])) {\n        throw new Error('duplicate');\n      }\n    });\n  }\n\n  internalPopulateIndices(value) {\n    this.keys.forEach(({ map }, key) => {\n      const v = value[key];\n      let o = map.get(v);\n      if (!o) {\n        o = new Set();\n        map.set(v, o);\n      }\n      o.add(value.id);\n    });\n  }\n\n  internalRemoveIndices(value) {\n    this.keys.forEach(({ map }, key) => {\n      const v = value[key];\n      const o = map.get(v);\n      o.delete(value.id);\n      if (!o.length) {\n        map.delete(v);\n      }\n    });\n  }\n\n  async add(value) {\n    await sleep(this.simulatedLatency);\n\n    this.internalCheckDuplicates(value, true);\n    this.data.set(value.id, JSON.stringify(value));\n    this.internalPopulateIndices(value);\n  }\n\n  async update(keyName, key, value, { upsert = false } = {}) {\n    await sleep(this.simulatedLatency);\n\n    const id = this.internalGetIds(keyName, key)[0];\n    if (id === undefined) {\n      if (upsert) {\n        await this.add(Object.assign({ [keyName]: key }, value));\n      }\n      return;\n    }\n    const oldValue = JSON.parse(this.data.get(id));\n    const newValue = Object.assign({}, oldValue, value);\n    if (newValue.id !== oldValue.id) {\n      throw new Error('Cannot update id');\n    }\n    this.internalRemoveIndices(oldValue);\n    try {\n      this.internalCheckDuplicates(value, false);\n    } catch (e) {\n      this.internalPopulateIndices(oldValue);\n      throw e;\n    }\n    this.data.set(newValue.id, JSON.stringify(newValue));\n    this.internalPopulateIndices(newValue);\n  }\n\n  async get(keyName, key, fields = null) {\n    const all = await this.getAll(keyName, key, fields);\n    if (!all.length) {\n      return null;\n    }\n    return all[0];\n  }\n\n  async getAll(keyName, key, fields = null) {\n    await sleep(this.simulatedLatency);\n\n    let ids;\n    if (keyName) {\n      ids = this.internalGetIds(keyName, key);\n    } else {\n      ids = [...this.data.keys()];\n    }\n    return ids.map((id) => applyFilter(JSON.parse(this.data.get(id)), fields));\n  }\n}\n","import { URL } from 'url';\nimport MemoryCollection from './MemoryCollection';\n\nconst globalNamespace = 'collectionStorageInMemory';\n\nif (!global[globalNamespace]) {\n  global[globalNamespace] = new Map();\n}\n\nconst globalDbs = global[globalNamespace];\n\nexport default class MemoryDb {\n  static connect(url) {\n    const parsedUrl = new URL(url);\n    const name = parsedUrl.hostname;\n    if (name && globalDbs.has(name)) {\n      return globalDbs.get(name);\n    }\n    const params = parsedUrl.searchParams;\n    const simulatedLatency = Number(params.get('simulatedLatency'));\n    const db = new MemoryDb({ simulatedLatency });\n    if (name) {\n      globalDbs.set(name, db);\n    }\n    return db;\n  }\n\n  constructor({ simulatedLatency = 0 } = {}) {\n    this.simulatedLatency = simulatedLatency;\n    this.mapTables = new Map();\n  }\n\n  getCollection(name, keys) {\n    if (!this.mapTables.has(name)) {\n      this.mapTables.set(name, new MemoryCollection(\n        keys,\n        this.simulatedLatency,\n      ));\n    }\n    return this.mapTables.get(name);\n  }\n}\n","const MONGO_ID = '_id';\nconst ID = 'id';\n\nfunction fieldNameToMongo(name) {\n  if (name === ID) {\n    return MONGO_ID;\n  }\n  return name;\n}\n\nfunction convertToMongo(value) {\n  if (!value || value[ID] === undefined) {\n    return value;\n  }\n  const { [ID]: id, ...rest } = value;\n  return { [MONGO_ID]: id, ...rest };\n}\n\nfunction convertFromMongo(value) {\n  if (!value || value[MONGO_ID] === undefined) {\n    return value;\n  }\n  const { [MONGO_ID]: id, ...rest } = value;\n  return { [ID]: id, ...rest };\n}\n\nfunction makeMongoFields(names) {\n  const fields = {};\n  if (names) {\n    fields[MONGO_ID] = false;\n    names.forEach((fieldName) => {\n      fields[fieldNameToMongo(fieldName)] = true;\n    });\n  }\n  return fields;\n}\n\nexport default class MongoCollection {\n  constructor(collection, keys = {}) {\n    this.collection = collection;\n\n    Object.keys(keys).forEach((keyName) => {\n      const options = keys[keyName];\n      if (options.unique) {\n        collection.createIndex({ [keyName]: 1 }, { unique: true });\n      } else {\n        collection.createIndex({ [keyName]: 'hashed' });\n      }\n    });\n  }\n\n  async add(value) {\n    await this.collection.insertOne(convertToMongo(value));\n  }\n\n  async update(keyName, key, value, { upsert = false } = {}) {\n    await this.collection.updateOne(\n      { [fieldNameToMongo(keyName)]: key },\n      { $set: convertToMongo(value) },\n      { upsert },\n    );\n  }\n\n  async get(keyName, key, fields = null) {\n    const raw = await this.collection.findOne(\n      { [fieldNameToMongo(keyName)]: key },\n      { projection: makeMongoFields(fields) },\n    );\n    return convertFromMongo(raw);\n  }\n\n  async getAll(keyName, key, fields = null) {\n    const result = [];\n\n    let cursor;\n    const mFields = makeMongoFields(fields);\n    if (keyName) {\n      cursor = await this.collection.find(\n        { [fieldNameToMongo(keyName)]: key },\n        { projection: mFields },\n      );\n    } else {\n      cursor = await this.collection.find({}, { projection: mFields });\n    }\n    await cursor.forEach((raw) => result.push(convertFromMongo(raw)));\n\n    return result;\n  }\n}\n","import MongoCollection from './MongoCollection';\n\nexport default class MongoDb {\n  static async connect(url) {\n    const { MongoClient } = await import('mongodb');\n    const client = await MongoClient.connect(url, { useNewUrlParser: true });\n    return new MongoDb(client.db());\n  }\n\n  constructor(db) {\n    this.db = db;\n  }\n\n  getCollection(name, keys) {\n    const collection = this.db.collection(name);\n    return new MongoCollection(collection, keys);\n  }\n}\n","import CollectionStorage from './CollectionStorage';\n\nexport { default as MemoryDb } from './memory/MemoryDb';\nexport { default as MongoDb } from './mongo/MongoDb';\nexport default CollectionStorage;\n","import MemoryDb from './memory/MemoryDb';\nimport MongoDb from './mongo/MongoDb';\n\nexport default class CollectionStorage {\n  static async connect(url) {\n    let dbClass;\n    if (url.startsWith('memory')) {\n      dbClass = MemoryDb;\n    } else if (url.startsWith('mongodb')) {\n      dbClass = MongoDb;\n    } else {\n      throw new Error(`Unsupported database connection string: ${url}`);\n    }\n\n    try {\n      return await dbClass.connect(url);\n    } catch (e) {\n      throw new Error(`Failed to connect to database \"${url}\": ${e.message}`);\n    }\n  }\n}\n"],"sourceRoot":""}